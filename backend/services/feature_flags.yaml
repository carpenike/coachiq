# Feature flag definitions for CoachIQ backend
#
# This YAML file defines all available features, their enabled state, and dependencies.
#
# Naming convention: use descriptive, positive, boolean-style names (e.g., enable_x, show_y)
#
# Example:
# enable_bulk_actions:
#   enabled: true
#   depends_on:
#     - enable_admin_panel

# Core infrastructure features
persistence:
  enabled: true
  core: false
  depends_on: []
  description: "Data persistence service for SQLite databases, backups, themes, and user configurations"
  friendly_name: "Data Persistence"

entity_manager:
  enabled: true
  core: true
  depends_on: []
  description: "Entity state management and configuration service"
  friendly_name: "Entity Manager"

app_state:
  enabled: true
  core: true
  depends_on: [entity_manager]
  description: "Application state management service (legacy compatibility)"
  friendly_name: "Application State"

websocket:
  enabled: true
  core: true
  depends_on: [app_state]
  description: "WebSocket connection management for real-time updates"
  friendly_name: "Real-time WebSocket"

# CAN bus and protocol features
can_interface:
  enabled: true
  core: true
  depends_on: [app_state]
  description: "CAN bus interface capability"
  friendly_name: "CAN Interface"

can_interface_mapping:
  enabled: true
  core: false
  depends_on: [can_interface]
  description: "Logical CAN interface mapping service for portable coach configurations"
  friendly_name: "CAN Interface Mapping"

can_feature:
  enabled: true
  core: true
  depends_on: [can_interface, app_state]
  description: "CANBus feature for device communication"
  friendly_name: "CAN Bus Communication"

rvc:
  enabled: true
  core: true
  depends_on: [can_interface]
  description: "RV-C protocol integration for recreational vehicle systems with Phase 1 enhancements"
  friendly_name: "RV-C Protocol"
  enable_encoder: true
  enable_validator: true
  enable_security: true
  enable_performance: true
  max_queue_size: 10000

j1939:
  enabled: false
  core: false
  depends_on: [can_interface]
  description: "J1939 protocol integration for engine, transmission, and chassis systems with Cummins/Allison support"
  friendly_name: "J1939 Protocol"
  enable_cummins_extensions: true
  enable_allison_extensions: true
  enable_chassis_extensions: true
  enable_validator: true
  enable_security: true
  enable_performance: true
  enable_rvc_bridge: true
  max_queue_size: 10000

multi_network_can:
  enabled: false
  core: false
  depends_on: [can_interface]
  description: "Multi-network CAN management with network isolation, fault tolerance, and cross-protocol routing"
  friendly_name: "Multi-Network CAN Manager"
  enable_health_monitoring: true
  enable_fault_isolation: true
  enable_cross_network_routing: false
  enable_network_security: true
  max_networks: 8

firefly:
  enabled: false
  core: false
  depends_on: [rvc]
  description: "Firefly RV systems integration with proprietary DGN support, multiplexing, and safety interlocks"
  friendly_name: "Firefly RV Systems"
  enable_multiplexing: true
  enable_custom_dgns: true
  enable_state_interlocks: true
  enable_can_detective_integration: false
  enable_message_validation: true
  enable_sequence_validation: true
  multiplex_buffer_size: 100
  multiplex_timeout_ms: 1000
  supported_components:
    [
      "lighting",
      "climate",
      "slides",
      "awnings",
      "tanks",
      "inverters",
      "generators",
      "transfer_switches",
      "pumps",
    ]
  safety_interlock_components: ["slides", "awnings", "leveling_jacks"]

spartan_k2:
  enabled: false
  core: false
  depends_on: [j1939]
  description: "Spartan K2 chassis integration with advanced diagnostics, safety interlocks, and real-time monitoring"
  friendly_name: "Spartan K2 Chassis"
  enable_safety_interlocks: true
  enable_advanced_diagnostics: true
  enable_brake_monitoring: true
  enable_suspension_control: true
  enable_steering_monitoring: true
  enable_predictive_maintenance: false
  enable_message_validation: true
  enable_source_validation: true
  message_buffer_size: 100
  diagnostic_cache_size: 500
  brake_pressure_threshold: 80.0
  level_differential_threshold: 15.0
  steering_pressure_threshold: 1000.0
  max_steering_angle: 720.0
  safety_check_frequency: 5
  system_health_check_interval: 60
  supported_systems:
    [
      "brakes",
      "suspension",
      "steering",
      "electrical",
      "diagnostics",
      "safety",
      "leveling",
    ]
  safety_critical_components: ["brakes", "steering", "suspension"]

advanced_diagnostics:
  enabled: true
  core: false
  depends_on: [rvc, can_interface]
  description: "Advanced diagnostics with fault correlation, predictive maintenance, and cross-protocol DTC analysis"
  friendly_name: "Advanced Diagnostics"
  enable_dtc_processing: true
  enable_fault_correlation: true
  enable_predictive_maintenance: true
  enable_cross_protocol_analysis: true
  enable_manufacturer_specific_analysis: true
  enable_real_time_alerts: true
  correlation_time_window_seconds: 60.0
  dtc_retention_days: 90
  health_assessment_interval_seconds: 300.0
  prediction_confidence_threshold: 0.7
  performance_history_days: 30
  trend_analysis_minimum_samples: 10
  high_priority_systems: ["engine", "brakes", "steering", "safety"]
  max_concurrent_analyses: 5
  analysis_batch_size: 100
  memory_limit_mb: 50

# API Documentation
api_docs:
  enabled: true
  core: true
  depends_on: [websocket]
  description: "API documentation endpoints including Swagger UI and search functionality"
  friendly_name: "API Documentation"

# Notification system
notifications:
  enabled: true
  core: false
  depends_on: []
  description: "Unified notification system using Apprise for multi-channel delivery (SMTP, Slack, Discord)"
  friendly_name: "Notification System"
  smtp_enabled: false
  multi_channel_enabled: true
  template_engine: "jinja2"
  log_notifications: true
  default_title: "CoachIQ Notification"

# Authentication system
authentication:
  enabled: true
  core: false
  depends_on: [notifications]
  description: "Authentication system with JWT tokens, magic links, and admin user management"
  friendly_name: "Authentication System"
  mode: "auto" # auto, none, single-user, multi-user
  secret_key_auto_generate: true
  jwt_expire_minutes: 15
  magic_link_expire_minutes: 15
  enable_magic_links: true
  enable_oauth: false
  enable_refresh_tokens: true
  refresh_token_expire_days: 7
  enable_account_lockout: true
  max_failed_attempts: 5
  lockout_duration_minutes: 30
  lockout_escalation_factor: 2.0
  lockout_reset_success_count: 3
  max_lockout_duration_hours: 24
  rate_limit_auth_attempts: 5
  rate_limit_window_minutes: 15

multi_factor_authentication:
  enabled: false
  core: false
  depends_on: [authentication]
  description: "Multi-Factor Authentication (MFA) with TOTP support, backup codes, and recovery options"
  friendly_name: "Multi-Factor Authentication"
  enable_totp: true
  enable_backup_codes: true
  enable_recovery_codes: true
  totp_issuer: "CoachIQ"
  totp_digits: 6
  totp_window: 1
  backup_codes_count: 10
  backup_code_length: 8
  require_mfa_for_admin: false
  allow_mfa_bypass: true
  mfa_setup_grace_period_hours: 24
  backup_code_regeneration_threshold: 3

# Optional features
pushover:
  enabled: false
  core: false
  depends_on: []
  description: "Pushover notification service integration"
  friendly_name: "Pushover Notifications"

uptimerobot:
  enabled: false
  core: false
  depends_on: []
  description: "UptimeRobot monitoring service integration"
  friendly_name: "UptimeRobot Monitoring"

github_update_checker:
  enabled: false
  core: false
  depends_on: []
  description: "GitHub update checker service for application updates"
  friendly_name: "GitHub Update Checker"

log_history:
  enabled: true
  core: false
  depends_on: []
  description: "REST API and WebSocket endpoints for log history and log streaming (journald, JSON logs)"
  friendly_name: "Log History"

log_streaming:
  enabled: true
  core: false
  depends_on: [websocket]
  description: "WebSocket log streaming endpoints and handlers (buffering, filtering, rate limiting)"
  friendly_name: "Log Streaming"

# Enhanced dashboard and analytics features
dashboard_aggregation:
  enabled: true
  core: false
  depends_on: [entity_manager, websocket]
  description: "Aggregated dashboard endpoints for optimized data loading and real-time updates"
  friendly_name: "Dashboard Aggregation"

bulk_operations:
  enabled: true
  core: false
  depends_on: [entity_manager, can_interface]
  description: "Bulk control operations for entities and advanced filtering capabilities"
  friendly_name: "Bulk Operations"

system_analytics:
  enabled: true
  core: false
  depends_on: [entity_manager, can_interface]
  description: "System analytics, performance monitoring, and alerting features"
  friendly_name: "System Analytics"

activity_tracking:
  enabled: true
  core: false
  depends_on: [entity_manager, websocket]
  description: "Activity feed tracking and recent events monitoring"
  friendly_name: "Activity Tracking"

performance_analytics:
  enabled: true
  core: false
  depends_on: [can_interface]
  description: "Comprehensive performance analytics with telemetry collection, benchmarking, trend analysis, and optimization recommendations"
  friendly_name: "Performance Analytics"
  enable_telemetry_collection: true
  enable_protocol_telemetry: true
  enable_resource_monitoring: true
  enable_can_interface_monitoring: true
  enable_benchmarking: true
  enable_trend_analysis: true
  enable_optimization_recommendations: true
  enable_real_time_processing: true
  enable_websocket_updates: true
  enable_diagnostics_integration: true
  telemetry_collection_interval_seconds: 5.0
  resource_monitoring_interval_seconds: 10.0
  metric_retention_hours: 24
  baseline_establishment_hours: 1
  baseline_update_interval_hours: 24
  deviation_warning_threshold_percent: 20.0
  deviation_critical_threshold_percent: 50.0
  cpu_warning_threshold_percent: 80.0
  cpu_critical_threshold_percent: 90.0
  memory_warning_threshold_percent: 80.0
  memory_critical_threshold_percent: 90.0
  can_bus_load_warning_threshold_percent: 70.0
  can_bus_load_critical_threshold_percent: 85.0
  trend_analysis_window_hours: 4
  minimum_trend_samples: 10
  trend_significance_threshold: 0.7
  recommendation_confidence_threshold: 0.8
  max_recommendations_per_category: 5
  target_rvc_message_rate: 1000.0
  target_j1939_message_rate: 800.0
  target_api_response_time_ms: 50.0
  target_websocket_latency_ms: 10.0
  processing_batch_size: 100
  max_concurrent_analyses: 3
  memory_limit_mb: 100
  enable_performance_alerts: true
  alert_cooldown_seconds: 300.0
  websocket_update_interval_seconds: 5.0
  protocol_monitoring_enabled:
    rvc: true
    j1939: true
    firefly: true
    spartan_k2: true
  protocol_priority_weights:
    rvc: 1.0
    j1939: 1.2
    firefly: 1.0
    spartan_k2: 1.2

analytics_dashboard:
  enabled: true
  core: false
  depends_on: [performance_analytics, entity_manager]
  description: "Advanced analytics dashboard with performance visualization, trend analysis, and system health monitoring"
  friendly_name: "Analytics Dashboard"
  # Core settings (always available)
  memory_retention_hours: 2
  insight_generation_interval_seconds: 900
  pattern_analysis_interval_seconds: 1800
  max_memory_insights: 100
  max_memory_patterns: 50
  # Persistence settings (only used if persistence feature enabled)
  persistence_retention_days: 30
  enable_background_persistence: true
  sqlite_batch_size: 100

device_discovery:
  enabled: true
  core: false
  depends_on: [can_interface, rvc]
  description: "Active device polling and network discovery for CAN bus systems with PGN Request support and topology mapping"
  friendly_name: "Device Discovery & Polling"
  enable_device_polling: true
  enable_network_topology: true
  enable_availability_tracking: true
  enable_response_time_monitoring: true
  enable_protocol_bridge_discovery: true
  enable_websocket_updates: true
  polling_interval_seconds: 30.0
  discovery_interval_seconds: 300.0
  device_timeout_seconds: 120.0
  max_response_history: 10
  max_concurrent_polls: 20
  poll_retry_limit: 3
  poll_timeout_seconds: 5.0
  supported_protocols: ["rvc", "j1939", "firefly", "spartan_k2"]
  discovery_pgns:
    rvc: [0x1FEF2, 0x1FEDA, 0x1FEEB, 0x1FEE1, 0x1FED9, 0x1FED8, 0x1FED6]
    j1939: [0x1FEF2, 0x1FEE5, 0x1FEF1, 0x1FEE9, 0x1FEE8]
  status_pgns:
    light: 0x1FEDA
    tank: 0x1FEEB
    temperature: 0x1FEE1
    lock: 0x1FED9
    pump: 0x1FED8
    fan: 0x1FED6
  enable_device_identification: true
  enable_capability_discovery: true
  source_address: 0xE0
  broadcast_address: 0xFF

predictive_maintenance:
  enabled: true
  core: false
  depends_on: [entity_manager, can_interface]
  description: "Predictive maintenance with component health tracking, trend analysis, and proactive recommendations"
  friendly_name: "Predictive Maintenance"
  enable_health_scoring: true
  enable_trend_analysis: true
  enable_anomaly_detection: true
  enable_maintenance_recommendations: true
  enable_component_lifecycle_tracking: true
  enable_maintenance_history: true
  enable_predictive_alerts: true
  enable_fleet_learning: false
  health_assessment_interval_seconds: 300.0
  anomaly_detection_sensitivity: 0.7
  recommendation_confidence_threshold: 0.8
  health_score_decay_rate: 0.1
  trend_analysis_window_days: 30
  minimum_trend_samples: 10
  maintenance_reminder_days: [30, 7, 1]
  component_categories:
    [
      "battery",
      "generator",
      "hvac",
      "pump",
      "slide_out",
      "lighting",
      "engine",
      "transmission",
    ]
  health_thresholds:
    healthy: 80.0
    watch: 60.0
    advise: 40.0
    alert: 20.0
  lifecycle_tracking:
    usage_hours_weight: 0.4
    usage_cycles_weight: 0.3
    anomaly_weight: 0.3
  predictive_models:
    battery:
      voltage_trend_weight: 0.5
      capacity_trend_weight: 0.3
      charge_cycle_weight: 0.2
    mechanical:
      vibration_weight: 0.4
      temperature_weight: 0.3
      usage_hours_weight: 0.3
