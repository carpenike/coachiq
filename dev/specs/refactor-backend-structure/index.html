
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Documentation for the rvc2api project" name="description"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Refactor Backend Structure to Modular Architecture - rvc2api Documentation</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../assets/_mkdocstrings.css" rel="stylesheet"/>
<link href="../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="amber" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#refactor-backend-structure-to-modular-architecture">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="rvc2api Documentation" class="md-header__button md-logo" data-md-component="logo" href="../.." title="rvc2api Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            rvc2api Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Refactor Backend Structure to Modular Architecture
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../documentation-organization/">
        
  
  
    
  
  Documentation Guide

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../development-environments/">
          
  
  
  User Guide

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../architecture/backend/">
          
  
  
  Developer Guide

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../documentation-updates-summary/">
          
  
  
  Project Updates

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../refactor-web-ui-to-react/">
          
  
  
  Specs

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="rvc2api Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="rvc2api Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    rvc2api Documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../documentation-organization/">
<span class="md-ellipsis">
    Documentation Guide
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    User Guide
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
<span class="md-ellipsis">
    Getting Started
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_1">
<span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../development-environments/">
<span class="md-ellipsis">
    Development Environment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../vscode-extensions/">
<span class="md-ellipsis">
    VS Code Setup
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
<span class="md-ellipsis">
    System Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            System Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/overview/">
<span class="md-ellipsis">
    Project Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
<span class="md-ellipsis">
    API Reference
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/">
<span class="md-ellipsis">
    API Home
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/overview/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/openapi/">
<span class="md-ellipsis">
    OpenAPI Specification
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/entities/">
<span class="md-ellipsis">
    Entity Endpoints
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/can/">
<span class="md-ellipsis">
    CAN Endpoints
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/websocket/">
<span class="md-ellipsis">
    WebSocket API
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-ellipsis">
    RV-C Integration
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            RV-C Integration
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../rv-c-documentation-search/">
<span class="md-ellipsis">
    RV-C Documentation Search
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mixed-chunking-strategies/">
<span class="md-ellipsis">
    Mixed Chunking Strategies
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pdf-processing-guide/">
<span class="md-ellipsis">
    PDF Processing Guide
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
<span class="md-ellipsis">
    Deployment
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            Deployment
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../react-deployment/">
<span class="md-ellipsis">
    React Deployment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nixos-module/">
<span class="md-ellipsis">
    NixOS Module
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../environment-variable-integration/">
<span class="md-ellipsis">
    Environment Variables
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nixos-integration/">
<span class="md-ellipsis">
    NixOS Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../debian-repository/">
<span class="md-ellipsis">
    Debian Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../github-pages-deployment/">
<span class="md-ellipsis">
    GitHub Pages
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../enabling-github-pages/">
<span class="md-ellipsis">
    Enabling GitHub Pages
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../version-management/">
<span class="md-ellipsis">
    Version Management
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Developer Guide
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Developer Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
<span class="md-ellipsis">
    Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/backend/">
<span class="md-ellipsis">
    Backend Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/frontend/">
<span class="md-ellipsis">
    Frontend Architecture
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
<span class="md-ellipsis">
    Development
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
            Development
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend-development/">
<span class="md-ellipsis">
    Frontend Development
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend-theming/">
<span class="md-ellipsis">
    Frontend Theming
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/frontend-integration/">
<span class="md-ellipsis">
    API Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../enhanced-dev-environment/">
<span class="md-ellipsis">
    Enhanced Dev Environment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mcp-tools-setup/">
<span class="md-ellipsis">
    MCP Tools Setup
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
<span class="md-ellipsis">
    Quality Assurance
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
            Quality Assurance
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../code-quality-tools/">
<span class="md-ellipsis">
    Code Quality Tools
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pyright-type-checking/">
<span class="md-ellipsis">
    Pyright Type Checking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pre-commit-and-actions/">
<span class="md-ellipsis">
    Pre-Commit Hooks
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../eslint-typescript-config/">
<span class="md-ellipsis">
    ESLint TypeScript Config
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
<span class="md-ellipsis">
    Build System
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_4">
<span class="md-nav__icon md-icon"></span>
            Build System
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../poetry2nix-integration/">
<span class="md-ellipsis">
    Poetry2Nix Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dependency-management-scripts/">
<span class="md-ellipsis">
    Dependency Management Scripts
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../github-actions/">
<span class="md-ellipsis">
    GitHub Actions
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../github-actions-summary/">
<span class="md-ellipsis">
    GitHub Actions Summary
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
<span class="md-ellipsis">
    Contributing
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_5">
<span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing/documentation/">
<span class="md-ellipsis">
    Documentation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing/openapi/">
<span class="md-ellipsis">
    OpenAPI
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing/pull-requests/">
<span class="md-ellipsis">
    Pull Request Guidelines
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Project Updates
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Project Updates
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../documentation-updates-summary/">
<span class="md-ellipsis">
    Documentation Updates
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mkdocs-config-update/">
<span class="md-ellipsis">
    MkDocs Configuration Update
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../react-migration-summary/">
<span class="md-ellipsis">
    React Migration Summary
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../test-mermaid/">
<span class="md-ellipsis">
    Diagrams Test
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mkdocs-versioning/">
<span class="md-ellipsis">
    Documentation Versioning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mkdocs-versioning-integration/">
<span class="md-ellipsis">
    Versioning Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../verifying-versioned-documentation/">
<span class="md-ellipsis">
    Verifying Versioning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../versioning-with-release-please/">
<span class="md-ellipsis">
    Versioning with Release-Please
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../docs-versioning-fixes/">
<span class="md-ellipsis">
    Versioning Fixes
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../documentation-versioning-update/">
<span class="md-ellipsis">
    Versioning Updates
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../version-management/">
<span class="md-ellipsis">
    Version Management
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Specs
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Specs
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../refactor-web-ui-to-react/">
<span class="md-ellipsis">
    React Frontend Migration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../spec-aware-decoder/">
<span class="md-ellipsis">
    Spec-Aware Decoder
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="refactor-backend-structure-to-modular-architecture">Refactor Backend Structure to Modular Architecture<a class="headerlink" href="#refactor-backend-structure-to-modular-architecture" title="Permanent link">¶</a></h1>
<h2 id="1-refactoring-objective">1. Refactoring Objective<a class="headerlink" href="#1-refactoring-objective" title="Permanent link">¶</a></h2>
<h3 id="11-purpose">1.1. Purpose<a class="headerlink" href="#11-purpose" title="Permanent link">¶</a></h3>
<ul>
<li>Reorganize the backend structure to improve modularity, maintainability, and extensibility</li>
<li>Prepare the codebase for new features like coach maintenance tracking</li>
<li>Create clear separation of concerns between different functional areas</li>
<li>Establish a consistent pattern for future backend development</li>
<li>Transition from the current mixed structure to a more standardized FastAPI monorepo organization</li>
</ul>
<h3 id="12-scope">1.2. Scope<a class="headerlink" href="#12-scope" title="Permanent link">¶</a></h3>
<ul>
<li>Affected: <code>src/core_daemon/</code>, <code>src/rvc_decoder/</code>, <code>src/common/</code></li>
<li>Unchanged: Business logic and API functionality will remain the same, only the structure changes</li>
<li>Boundaries: Focus is on backend reorganization; no changes to frontend integration or overall system behavior</li>
</ul>
<h2 id="2-current-state-analysis">2. Current State Analysis<a class="headerlink" href="#2-current-state-analysis" title="Permanent link">¶</a></h2>
<h3 id="21-code-structure">2.1. Code Structure<a class="headerlink" href="#21-code-structure" title="Permanent link">¶</a></h3>
<ul>
<li>Backend code is currently split across multiple directories:</li>
<li><code>src/common/</code>: Shared models and utilities</li>
<li><code>src/core_daemon/</code>: FastAPI application, API routers, state management</li>
<li><code>src/rvc_decoder/</code>: DGN decoding, mappings</li>
<li>The <code>core_daemon</code> module contains a mix of concerns (API, WebSockets, state management)</li>
<li>Future plans already include coach maintenance and other features that would benefit from clearer separation</li>
</ul>
<h3 id="22-code-quality-concerns">2.2. Code Quality Concerns<a class="headerlink" href="#22-code-quality-concerns" title="Permanent link">¶</a></h3>
<ul>
<li>Limited separation between API definition, business logic, and data access</li>
<li>Tight coupling between components makes it difficult to add new features without modifying existing code</li>
<li>Core daemon has grown to include various responsibilities that could be better separated</li>
<li>Limited modularity makes testing more difficult</li>
</ul>
<h3 id="23-test-coverage">2.3. Test Coverage<a class="headerlink" href="#23-test-coverage" title="Permanent link">¶</a></h3>
<ul>
<li>Existing tests need to be updated to reflect the new structure</li>
<li>Current testing approach focused on high-level API tests rather than modular unit tests</li>
<li>Refactoring provides an opportunity to improve test organization and coverage</li>
</ul>
<h2 id="3-refactoring-plan">3. Refactoring Plan<a class="headerlink" href="#3-refactoring-plan" title="Permanent link">¶</a></h2>
<h3 id="31-architectural-changes">3.1. Architectural Changes<a class="headerlink" href="#31-architectural-changes" title="Permanent link">¶</a></h3>
<ul>
<li>Create a new <code>backend/</code> directory at the project root to house all backend code</li>
<li>Organize code by functional areas rather than technical layers</li>
<li>Separate core application configuration from business logic</li>
<li>Create a clear distinction between API definition and service implementation</li>
<li>Establish dedicated directories for integrations (RV-C, future integrations like Victron)</li>
<li>Prepare for new features like coach maintenance tracking</li>
</ul>
<h3 id="32-code-structure-changes">3.2. Code Structure Changes<a class="headerlink" href="#32-code-structure-changes" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>New structure:
  <div class="highlight"><pre><span></span><code>backend/
├── api/                 # API definition and routes
│   ├── routers/         # APIRouter modules organized by domain
│   └── endpoints/       # Endpoint implementations
├── core/                # Core application logic
│   ├── config.py        # Configuration handling
│   ├── app.py           # FastAPI app factory
│   └── state.py         # Application state management
├── integrations/        # External system integrations
│   ├── can/             # CAN bus integration
│   └── rvc/             # RV-C decoder (moved from src/rvc_decoder)
├── services/            # Business logic services
│   ├── entity_service.py # Entity-related business logic
│   ├── can_service.py   # CAN-related business logic
│   └── maintenance/     # New maintenance tracking features
├── models/              # Pydantic models
│   ├── common.py        # Shared models (from src/common/models.py)
│   ├── entities.py      # Entity-related models
│   └── maintenance.py   # New maintenance-related models
├── middleware/          # HTTP and WebSocket middleware
├── websocket/           # WebSocket handlers
└── main.py              # Entry point
</code></pre></div></p>
</li>
<li>
<p>Files to be moved or refactored (with analysis):</p>
</li>
</ul>
<p>### Core Components
  - <code>src/core_daemon/app_state.py</code> → <code>backend/core/state.py</code>
    - <strong>Purpose</strong>: Manages in-memory application state, entity data, history, and client connections
    - <strong>Analysis</strong>: Core application component that other modules depend on
    - <strong>Dependencies</strong>: Imports from config, metrics, models
    - <strong>Refactoring Notes</strong>: Will require careful handling of circular dependencies with websocket.py</p>
<ul>
<li>
<p><code>src/core_daemon/config.py</code> → <code>backend/core/config.py</code></p>
<ul>
<li><strong>Purpose</strong>: Handles application configuration, logging, path resolution, and environment settings</li>
<li><strong>Analysis</strong>: Configuration is a core concern, correctly placed in core module</li>
<li><strong>Dependencies</strong>: Minimal external dependencies</li>
<li><strong>Refactoring Notes</strong>: Should be one of the first files to migrate to avoid dependency issues</li>
</ul>
</li>
<li>
<p><code>src/core_daemon/main.py</code> → <code>backend/main.py</code></p>
<ul>
<li><strong>Purpose</strong>: Application entry point, initialization, and orchestration</li>
<li><strong>Analysis</strong>: High-level bootstrap code that ties components together</li>
<li><strong>Dependencies</strong>: Imports from many modules</li>
<li><strong>Refactoring Notes</strong>: Should be simplified to delegate more responsibility to service modules</li>
</ul>
</li>
<li>
<p><code>src/core_daemon/metrics.py</code> → <code>backend/core/metrics.py</code> (Missing in original plan)</p>
<ul>
<li><strong>Purpose</strong>: Defines Prometheus metrics for monitoring</li>
<li><strong>Analysis</strong>: Core infrastructure concern used across multiple components</li>
<li><strong>Dependencies</strong>: Minimal external dependencies</li>
<li><strong>Refactoring Notes</strong>: Important to migrate early as it's used by many components</li>
</ul>
</li>
</ul>
<p>### API and Routers
  - <code>src/core_daemon/api_routers/*.py</code> → <code>backend/api/routers/*.py</code>
    - <strong>Purpose</strong>: Define API endpoints organized by domain
    - <strong>Analysis</strong>: Properly placed in api/routers, but contain business logic that should be extracted
    - <strong>Dependencies</strong>: Import app_state and models extensively
    - <strong>Refactoring Notes</strong>: Business logic should be extracted to service modules</p>
<p>### Integration Components
  - <code>src/core_daemon/can_manager.py</code> → <code>backend/integrations/can/manager.py</code>
    - <strong>Purpose</strong>: Manages CAN bus communication, listeners, and message construction
    - <strong>Analysis</strong>: Hardware integration component, correctly placed in integrations
    - <strong>Dependencies</strong>: Minimal external dependencies
    - <strong>Refactoring Notes</strong>: Clean interfaces between this and business logic should be established</p>
<ul>
<li>
<p><code>src/core_daemon/can_processing.py</code> → <code>backend/integrations/can/processing.py</code></p>
<ul>
<li><strong>Purpose</strong>: Processes incoming CAN messages, updates application state</li>
<li><strong>Analysis</strong>: Handles integration between CAN bus and application state</li>
<li><strong>Dependencies</strong>: Imports app_state, websocket, metrics, models</li>
<li><strong>Refactoring Notes</strong>: Consider splitting business logic into a separate service</li>
</ul>
</li>
<li>
<p><code>src/rvc_decoder/*</code> → <code>backend/integrations/rvc/*</code></p>
<ul>
<li><strong>Purpose</strong>: Decodes RV-C protocol messages from CAN frames</li>
<li><strong>Analysis</strong>: Protocol-specific integration, correctly placed in integrations</li>
<li><strong>Dependencies</strong>: Imports common.models</li>
<li><strong>Refactoring Notes</strong>: Clean separation from business logic should be maintained</li>
</ul>
</li>
</ul>
<p>### WebSocket Handling
  - <code>src/core_daemon/websocket.py</code> → <code>backend/websocket/handlers.py</code>
    - <strong>Purpose</strong>: Manages WebSocket connections, clients, and message broadcasting
    - <strong>Analysis</strong>: Communication layer separate from HTTP API, warrants its own module
    - <strong>Dependencies</strong>: Circular dependency with app_state
    - <strong>Refactoring Notes</strong>: Circular dependency with app_state needs careful handling</p>
<p>### Models
  - <code>src/common/models.py</code> → <code>backend/models/common.py</code>
    - <strong>Purpose</strong>: Shared Pydantic models used across modules
    - <strong>Analysis</strong>: Base models that should be accessible to all components
    - <strong>Dependencies</strong>: Minimal (just Pydantic)
    - <strong>Refactoring Notes</strong>: Should be migrated early as other components depend on it</p>
<ul>
<li><code>src/core_daemon/models.py</code> → Split into domain-specific models:<ul>
<li><strong>Purpose</strong>: Contains multiple domain-specific Pydantic models</li>
<li><strong>Analysis</strong>: Should be split by domain to improve separation of concerns</li>
<li><strong>Split Strategy</strong>:</li>
<li><code>backend/models/entities.py</code>: Entity-related models</li>
<li><code>backend/models/can.py</code>: CAN-related models</li>
<li><code>backend/models/github.py</code>: GitHub update models</li>
<li><strong>Refactoring Notes</strong>: Update imports in dependent files after splitting</li>
</ul>
</li>
</ul>
<p>### Additional Components (Missing in original plan)
  - <code>src/core_daemon/feature_manager.py</code> → <code>backend/services/feature_manager.py</code>
    - <strong>Purpose</strong>: Manages feature flags and optional components
    - <strong>Analysis</strong>: Business logic that manages application features
    - <strong>Dependencies</strong>: Various application components
    - <strong>Refactoring Notes</strong>: Consider refactoring into a proper service pattern</p>
<ul>
<li><code>src/core_daemon/middleware.py</code> → <code>backend/middleware/http.py</code><ul>
<li><strong>Purpose</strong>: HTTP middleware like CORS and metrics collection</li>
<li><strong>Analysis</strong>: Web framework infrastructure component</li>
<li><strong>Dependencies</strong>: Imports metrics</li>
<li><strong>Refactoring Notes</strong>: Consider expanding to include additional middleware</li>
</ul>
</li>
</ul>
<h3 id="33-feature-management-system-modern-approach">3.3. Feature Management System (Modern Approach)<a class="headerlink" href="#33-feature-management-system-modern-approach" title="Permanent link">¶</a></h3>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h3>
<p>The backend now uses a modern, config-driven, dependency-aware feature management system. This system is designed for extensibility, testability, and clear separation of feature logic. It consists of:</p>
<ul>
<li><strong>FeatureManager</strong>: Central service for feature registration, dependency resolution, lifecycle management, and status reporting. Features are loaded from a YAML config and registered at startup.</li>
<li><strong>Feature Base Class</strong>: All features inherit from <code>Feature</code> (see <code>backend/services/feature_base.py</code>), which provides lifecycle hooks (<code>startup</code>, <code>shutdown</code>), health reporting, and dependency declaration.</li>
<li><strong>YAML Configuration</strong>: Features and their dependencies are defined in <code>backend/services/feature_flags.yaml</code>. This file controls which features are enabled, their core/optional status, and their dependencies.</li>
</ul>
<h3 id="key-patterns">Key Patterns<a class="headerlink" href="#key-patterns" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Config-Driven</strong>: Features are enabled/disabled and configured via YAML, not hardcoded.</li>
<li><strong>Dependency-Aware</strong>: Features can declare dependencies on other features. The manager resolves and starts them in the correct order.</li>
<li><strong>Extensible</strong>: New features are added by subclassing <code>Feature</code> and registering with the manager.</li>
<li><strong>Service-Oriented</strong>: All feature logic and registration must use the new pattern; legacy ad-hoc feature flags are deprecated.</li>
</ul>
<h3 id="example-yaml">Example YAML<a class="headerlink" href="#example-yaml" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">canbus</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">core</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">web_ui</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">core</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">maintenance_tracking</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">core</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">canbus</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h3 id="example-feature-class">Example Feature Class<a class="headerlink" href="#example-feature-class" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.feature_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Feature</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaintenanceTrackingFeature</span><span class="p">(</span><span class="n">Feature</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Custom startup logic</span>
        <span class="k">pass</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Custom shutdown logic</span>
        <span class="k">pass</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"healthy"</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="k">else</span> <span class="s2">"disabled"</span>
</code></pre></div>
<h3 id="example-featuremanager-usage">Example FeatureManager Usage<a class="headerlink" href="#example-featuremanager-usage" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.feature_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.feature_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Feature</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">FeatureManager</span><span class="p">()</span>
<span class="n">manager</span><span class="o">.</span><span class="n">register_feature</span><span class="p">(</span><span class="n">MaintenanceTrackingFeature</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"maintenance_tracking"</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">manager</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="s2">"maintenance_tracking"</span><span class="p">)</span>  <span class="c1"># True/False</span>
</code></pre></div>
<h3 id="migration-notes">Migration Notes<a class="headerlink" href="#migration-notes" title="Permanent link">¶</a></h3>
<ul>
<li>All feature logic and registration must use the new FeatureManager/Feature/YAML pattern.</li>
<li>Remove legacy feature flag code and update all imports to use <code>backend/services/feature_manager.py</code> and <code>feature_base.py</code>.</li>
<li>Update documentation and OpenAPI specs to reflect feature-conditional endpoints.</li>
</ul>
<hr/>
<h3 id="34-interface-changes">3.4. Interface Changes<a class="headerlink" href="#34-interface-changes" title="Permanent link">¶</a></h3>
<ul>
<li>No changes to public APIs; internal imports will be updated</li>
<li>Maintain backward compatibility during transition</li>
<li>Code refactoring will preserve API contracts and behavior</li>
</ul>
<h3 id="35-testing-strategy">3.5. Testing Strategy<a class="headerlink" href="#35-testing-strategy" title="Permanent link">¶</a></h3>
<ul>
<li>Update existing tests to use the new import paths</li>
<li>Add unit tests for newly refactored modules</li>
<li>Improve test isolation with the new modular structure</li>
<li>Use the refactoring as an opportunity to increase test coverage</li>
</ul>
<h2 id="4-implementation-strategy">4. Implementation Strategy<a class="headerlink" href="#4-implementation-strategy" title="Permanent link">¶</a></h2>
<h3 id="41-phased-approach">4.1. Phased Approach<a class="headerlink" href="#41-phased-approach" title="Permanent link">¶</a></h3>
<p>The migration will follow a dependency-driven phased approach, starting with the least dependent components and gradually working up to the most integrated ones:</p>
<ul>
<li><strong>Phase 1: Foundation Setup</strong></li>
<li>Set up the new directory structure</li>
<li>Create minimal entry points and infrastructure</li>
<li>Migrate low-dependency modules first:<ol>
<li><code>src/common/models.py</code> → <code>backend/models/common.py</code></li>
<li><code>src/core_daemon/config.py</code> → <code>backend/core/config.py</code></li>
<li><code>src/core_daemon/metrics.py</code> → <code>backend/core/metrics.py</code></li>
<li><code>src/rvc_decoder/*</code> → <code>backend/integrations/rvc/*</code></li>
</ol>
</li>
<li>
<p><strong>Status:</strong> <em>Complete. The foundational backend directory structure and initial package files are already in place.</em></p>
</li>
<li>
<p><strong>Phase 2: Core Services Migration</strong></p>
</li>
<li>Create initial service layer modules</li>
<li>Move key components with carefully managed dependencies:<ol>
<li>Split <code>src/core_daemon/models.py</code> into domain-specific model files</li>
<li><code>src/core_daemon/middleware.py</code> → <code>backend/middleware/http.py</code></li>
<li><code>src/core_daemon/can_manager.py</code> → <code>backend/integrations/can/manager.py</code></li>
<li>Create skeleton for <code>entity_service.py</code> and <code>can_service.py</code></li>
<li>Create enhanced feature management:</li>
<li>Create <code>backend/services/feature_base.py</code> with improved Feature base class</li>
<li>Create <code>backend/services/feature_manager.py</code> with FeatureManager service class</li>
<li>Add <code>backend/services/feature_flags.yaml</code> for config-driven feature definitions</li>
<li>Require all feature logic and registration to use the new FeatureManager/Feature/YAML pattern</li>
<li>Remove legacy feature flag code and update all imports to use new backend module paths</li>
<li>Update documentation and OpenAPI specs to reflect feature-conditional endpoints</li>
<li>Add feature dependency resolution logic</li>
</ol>
</li>
<li>
<p><strong>Status:</strong> <em>Complete. All core service skeletons, feature management, and migration to the new backend structure are done. Proceed to Phase 3 for state, API, and integration migration.</em></p>
</li>
<li>
<p><strong>Phase 3: State and API Migration</strong></p>
</li>
<li>
<p>Handle the more complex interdependent components:</p>
<ol>
<li>Refactor <code>src/core_daemon/app_state.py</code> → <code>backend/core/state.py</code></li>
<li>Migrate <code>src/core_daemon/websocket.py</code> → <code>backend/websocket/handlers.py</code></li>
<li>Move API routers to <code>backend/api/routers/</code> with service layer refactoring</li>
<li>Refactor <code>src/core_daemon/can_processing.py</code> → <code>backend/integrations/can/processing.py</code></li>
<li>Move <code>src/core_daemon/feature_manager.py</code> → <code>backend/services/feature_manager.py</code></li>
</ol>
</li>
<li>
<p><strong>Phase 4: Entry Point and Final Integration</strong></p>
</li>
<li>
<p>Tie everything together with the main application:</p>
<ol>
<li>Create a simplified <code>backend/main.py</code></li>
<li>Implement dependency injection where appropriate</li>
<li>Create a compatibility layer for transition period</li>
<li>Add comprehensive test coverage for the new structure</li>
</ol>
</li>
<li>
<p><strong>Phase 3: Service Refactoring</strong></p>
</li>
<li>Split monolithic services into domain-specific modules</li>
<li>Create proper separation between API, services, and data access</li>
<li>
<p>Update imports and references</p>
</li>
<li>
<p><strong>Phase 4: New Features &amp; Cleanup</strong></p>
</li>
<li>Implement coach maintenance features in the new structure</li>
<li>Remove deprecated code paths</li>
<li>Update documentation</li>
</ul>
<h3 id="42-dependency-challenges-and-solutions">4.2. Dependency Challenges and Solutions<a class="headerlink" href="#42-dependency-challenges-and-solutions" title="Permanent link">¶</a></h3>
<p>During the analysis, several dependency challenges were identified that will require special handling:</p>
<h4 id="circular-dependencies">Circular Dependencies<a class="headerlink" href="#circular-dependencies" title="Permanent link">¶</a></h4>
<ul>
<li><strong>app_state.py ↔ websocket.py</strong>: These files import from each other, creating a circular dependency</li>
<li><strong>Solution</strong>: Create a new module <code>backend/core/events.py</code> to handle the event dispatch that both modules need</li>
<li><strong>Strategy</strong>: Extract the shared functionality to break the circular dependency</li>
</ul>
<h4 id="heavy-state-dependencies">Heavy State Dependencies<a class="headerlink" href="#heavy-state-dependencies" title="Permanent link">¶</a></h4>
<ul>
<li>Many modules directly import from app_state.py, creating tight coupling</li>
<li><strong>Solution</strong>: Implement a service layer that accesses state rather than having components access state directly</li>
<li><strong>Strategy</strong>: Create services like <code>entity_service.py</code> that mediate access to application state</li>
</ul>
<h4 id="business-logic-in-api-routers">Business Logic in API Routers<a class="headerlink" href="#business-logic-in-api-routers" title="Permanent link">¶</a></h4>
<ul>
<li>API router files contain business logic that should be in service modules</li>
<li><strong>Solution</strong>: Extract business logic from routers to dedicated service modules</li>
<li><strong>Strategy</strong>: Routers should only handle HTTP concerns; service modules handle business logic</li>
</ul>
<h3 id="43-risk-mitigation">4.3. Risk Mitigation<a class="headerlink" href="#43-risk-mitigation" title="Permanent link">¶</a></h3>
<ul>
<li>Maintain comprehensive test coverage throughout the refactoring</li>
<li>Implement changes incrementally, testing at each step</li>
<li>Create compatibility layers where needed during the transition</li>
<li>Document all changes clearly for future reference</li>
<li>Create explicit interfaces between modules to reduce coupling</li>
<li>Use dependency injection where appropriate to improve testability</li>
</ul>
<h3 id="44-validation-checkpoints">4.4. Validation Checkpoints<a class="headerlink" href="#44-validation-checkpoints" title="Permanent link">¶</a></h3>
<p>Each phase of migration requires validation to ensure functionality is preserved:</p>
<h4 id="phase-1-validation">Phase 1 Validation<a class="headerlink" href="#phase-1-validation" title="Permanent link">¶</a></h4>
<ul>
<li>Verify models can be imported and used in existing code</li>
<li>Ensure configuration loading works correctly</li>
<li>Confirm metrics registration is functioning</li>
<li>Test RV-C decoder functionality in isolation</li>
</ul>
<h4 id="phase-2-validation">Phase 2 Validation<a class="headerlink" href="#phase-2-validation" title="Permanent link">¶</a></h4>
<ul>
<li>Verify domain-specific models properly replace the original models module</li>
<li>Ensure middleware functions correctly with new imports</li>
<li>Test CAN manager initialization and operation</li>
<li>Validate initial service layer functionality</li>
</ul>
<h4 id="phase-3-validation">Phase 3 Validation<a class="headerlink" href="#phase-3-validation" title="Permanent link">¶</a></h4>
<ul>
<li>Confirm application state management is fully functional</li>
<li>Test WebSocket connections and message broadcasting</li>
<li>Verify API endpoints respond correctly with refactored dependencies</li>
<li>Ensure CAN message processing updates state correctly</li>
<li>Check feature manager functionality</li>
</ul>
<h4 id="phase-4-validation">Phase 4 Validation<a class="headerlink" href="#phase-4-validation" title="Permanent link">¶</a></h4>
<ul>
<li>Run full integration tests with the new main entry point</li>
<li>Test API endpoints to verify that external behavior remains consistent</li>
<li>Check WebSocket functionality to ensure real-time updates work correctly</li>
<li>Verify that CAN bus integration continues to function as expected</li>
<li>Ensure backwards compatibility is maintained for existing clients</li>
</ul>
<h2 id="5-code-migration-guide">5. Code Migration Guide<a class="headerlink" href="#5-code-migration-guide" title="Permanent link">¶</a></h2>
<h3 id="51-old-vs-new-patterns">5.1. Old vs. New Patterns<a class="headerlink" href="#51-old-vs-new-patterns" title="Permanent link">¶</a></h3>
<ul>
<li>
<p><strong>BEFORE</strong>: Mixed responsibility modules with tight coupling:
  <div class="highlight"><pre><span></span><code><span class="c1"># Direct import from core_daemon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core_daemon.app_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_entity_state</span>
</code></pre></div></p>
</li>
<li>
<p><strong>AFTER</strong>: Clear separation of concerns with modular imports:
  <div class="highlight"><pre><span></span><code><span class="c1"># Service-oriented approach</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.entity_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_entity</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="52-deprecation-path">5.2. Deprecation Path<a class="headerlink" href="#52-deprecation-path" title="Permanent link">¶</a></h3>
<ul>
<li>Keep old modules initially with imports from new locations</li>
<li>Gradually migrate callers to use new import paths</li>
<li>Remove deprecated code after all callers are updated</li>
</ul>
<h2 id="6-documentation-updates">6. Documentation Updates<a class="headerlink" href="#6-documentation-updates" title="Permanent link">¶</a></h2>
<h3 id="61-code-documentation">6.1. Code Documentation<a class="headerlink" href="#61-code-documentation" title="Permanent link">¶</a></h3>
<ul>
<li>Update all docstrings to reflect new module locations</li>
<li>Update architecture documentation with new structure</li>
<li>Create diagrams showing the revised component organization</li>
<li>Document patterns for extending the system with new services</li>
</ul>
<h3 id="62-user-documentation">6.2. User Documentation<a class="headerlink" href="#62-user-documentation" title="Permanent link">¶</a></h3>
<ul>
<li>Update API documentation to reflect any path changes or enhancements</li>
<li>Document the transition if relevant to users of the system</li>
<li>Update developer setup instructions for the new structure</li>
</ul>
<h2 id="7-execution-checklist">7. Execution Checklist<a class="headerlink" href="#7-execution-checklist" title="Permanent link">¶</a></h2>
<h3 id="71-preparation">7.1. Preparation<a class="headerlink" href="#71-preparation" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Create detailed dependency graph of existing modules</li>
<li>[ ] Map all import statements across the codebase</li>
<li>[ ] Establish test baseline to verify functionality preservation</li>
<li>[ ] Create comprehensive test cases for critical functionality</li>
<li>[ ] Draft interface definitions for new service modules</li>
<li>[ ] Create new directory structure</li>
</ul>
<h3 id="72-phase-1-foundation-setup">7.2. Phase 1: Foundation Setup<a class="headerlink" href="#72-phase-1-foundation-setup" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Migrate <code>common/models.py</code> to <code>backend/models/common.py</code></li>
<li>[ ] Migrate <code>core_daemon/config.py</code> to <code>backend/core/config.py</code></li>
<li>[ ] Migrate <code>core_daemon/metrics.py</code> to <code>backend/core/metrics.py</code></li>
<li>[ ] Migrate <code>rvc_decoder/</code> to <code>backend/integrations/rvc/</code></li>
<li>[ ] Verify imports still work with compatibility layer</li>
<li>[ ] Run tests to verify phase 1 components function correctly</li>
</ul>
<h3 id="73-core-components-phase-week-2-3">7.3. Core Components Phase (Week 2-3)<a class="headerlink" href="#73-core-components-phase-week-2-3" title="Permanent link">¶</a></h3>
<ul>
<li>[x] Split domain-specific models:</li>
<li>[x] Create <code>backend/models/entities.py</code>, <code>backend/models/can.py</code>, etc.</li>
<li>[x] Update imports in dependent files</li>
<li>[x] Create compatibility imports</li>
<li>[x] Migrate middleware:</li>
<li>[x] <code>src/core_daemon/middleware.py</code> → <code>backend/middleware/http.py</code></li>
<li>[x] Migrate CAN integration:</li>
<li>[x] <code>src/core_daemon/can_manager.py</code> → <code>backend/integrations/can/manager.py</code></li>
<li>[x] Create <code>backend/integrations/can/interface.py</code> implementing <code>IntegrationInterface</code></li>
<li>[x] Create initial service layer:</li>
<li>[x] <code>backend/services/entity_service.py</code></li>
<li>[x] <code>backend/services/can_service.py</code></li>
<li>[x] Create enhanced feature management:</li>
<li>[x] Create <code>backend/services/feature_base.py</code> with improved Feature base class</li>
<li>[x] Create <code>backend/services/feature_manager.py</code> with FeatureManager service class</li>
<li>[x] Add <code>backend/services/feature_flags.yaml</code> for config-driven feature definitions</li>
<li>[x] Require all feature logic and registration to use the new FeatureManager/Feature/YAML pattern</li>
<li>[x] Remove legacy feature flag code and update all imports to use new backend module paths</li>
<li>[x] Update documentation and OpenAPI specs to reflect feature-conditional endpoints</li>
<li>[x] Add feature dependency resolution logic</li>
<li>[x] Create tests for all migrated components (to be expanded in later phases)</li>
</ul>
<p><em>Phase 2 complete: All core service skeletons, feature management, and migration to the new backend structure are done. Proceed to Phase 3 for state, API, and integration migration.</em></p>
<h3 id="74-phase-3-state-and-api-migration">7.4. Phase 3: State and API Migration<a class="headerlink" href="#74-phase-3-state-and-api-migration" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Refactor <code>core_daemon/app_state.py</code> to <code>backend/core/state.py</code></li>
<li>[ ] Migrate <code>core_daemon/websocket.py</code> to <code>backend/websocket/handlers.py</code></li>
<li>[ ] Migrate API routers with extracted business logic:</li>
<li>[ ] <code>core_daemon/api_routers/entities.py</code> → <code>backend/api/routers/entities.py</code></li>
<li>[ ] <code>core_daemon/api_routers/can.py</code> → <code>backend/api/routers/can.py</code></li>
<li>[ ] Other API router modules</li>
<li>[ ] Move business logic to appropriate service modules</li>
<li>[ ] Migrate <code>core_daemon/can_processing.py</code> to <code>backend/integrations/can/processing.py</code></li>
<li>[ ] Migrate <code>core_daemon/feature_manager.py</code> to <code>backend/services/feature_manager.py</code></li>
<li>[ ] Run tests to verify phase 3 components function correctly</li>
</ul>
<h3 id="75-phase-4-entry-point-and-final-integration">7.5. Phase 4: Entry Point and Final Integration<a class="headerlink" href="#75-phase-4-entry-point-and-final-integration" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Create simplified <code>backend/main.py</code> with proper service initialization</li>
<li>[ ] Implement dependency injection where appropriate</li>
<li>[ ] Create compatibility layer for transition period</li>
<li>[ ] Add new coach maintenance service structure</li>
<li>[ ] Ensure all imports are updated throughout the codebase</li>
<li>[ ] Run full integration tests</li>
</ul>
<h3 id="76-verification">7.6. Verification<a class="headerlink" href="#76-verification" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Run complete test suite</li>
<li>[ ] Verify API behavior with automated and manual testing</li>
<li>[ ] Test WebSocket functionality thoroughly</li>
<li>[ ] Check performance metrics for any regressions</li>
<li>[ ] Test CAN bus integration with hardware or simulators</li>
<li>[ ] Review code quality with static analysis tools</li>
<li>[ ] Verify backward compatibility with existing clients</li>
</ul>
<h3 id="77-documentation-cleanup">7.7. Documentation &amp; Cleanup<a class="headerlink" href="#77-documentation-cleanup" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Update architecture documentation with new structure</li>
<li>[ ] Create sequence diagrams for key workflows</li>
<li>[ ] Update API documentation to reflect any changes</li>
<li>[ ] Remove deprecated code paths</li>
<li>[ ] Update VS Code tasks and development workflows</li>
<li>[ ] Update any CI/CD configurations</li>
<li>[ ] Document lessons learned during the refactoring</li>
</ul>
<h2 id="8-references">8. References<a class="headerlink" href="#8-references" title="Permanent link">¶</a></h2>
<ul>
<li><a href="https://fastapi.tiangolo.com/tutorial/bigger-applications/">FastAPI Bigger Applications Guide</a></li>
<li><a href="https://realpython.com/python-application-layouts/">Python Application Layouts</a></li>
<li>Current <code>docs/architecture/backend.md</code> documentation</li>
<li>Existing plan in project documentation about future architecture</li>
</ul>
<h2 id="9-integration-interface-patterns">9. Integration Interface Patterns<a class="headerlink" href="#9-integration-interface-patterns" title="Permanent link">¶</a></h2>
<p>One key goal of this refactoring is to prepare for additional device integration types beyond RV-C CAN bus. The new architecture should flexibly support different communication protocols with a common interface pattern.</p>
<h3 id="91-common-integration-interface">9.1. Common Integration Interface<a class="headerlink" href="#91-common-integration-interface" title="Permanent link">¶</a></h3>
<p>The following pattern defines a common interface that all integration types will implement:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/integrations/interfaces.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DeviceMessage</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Protocol for messages from any device integration."""</span>
    <span class="n">source_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">raw_data</span><span class="p">:</span> <span class="n">Any</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">'T'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">DeviceMessage</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IntegrationInterface</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Common interface for all device integrations."""</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize the integration and establish connections."""</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clean shutdown of the integration."""</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Send a message to a specific device."""</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_message_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return an async iterator yielding device messages."""</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_available_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return a list of available devices with their metadata."""</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Register a handler for incoming messages."""</span>
        <span class="k">pass</span>
</code></pre></div>
<h3 id="92-concrete-implementations">9.2. Concrete Implementations<a class="headerlink" href="#92-concrete-implementations" title="Permanent link">¶</a></h3>
<h4 id="rv-c-can-implementation">RV-C CAN Implementation<a class="headerlink" href="#rv-c-can-implementation" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/integrations/can/interface.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrationInterface</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.can.manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">CANManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.can.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CANMessage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CANIntegration</span><span class="p">(</span><span class="n">IntegrationInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""RV-C CAN bus integration implementation."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can_manager</span> <span class="o">=</span> <span class="n">CANManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize CAN bus connection and start listening."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_manager</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_messages</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Shutdown CAN bus connections."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Send a message to the CAN bus."""</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_manager</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">message_data</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_message_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">CANMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return an async iterator yielding CAN messages."""</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">CANMessage</span><span class="p">):</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_message_handler</span><span class="p">(</span><span class="n">_handler</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_available_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return a list of available CAN nodes."""</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="nb">hex</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"can_node"</span><span class="p">,</span> <span class="s2">"last_seen"</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_manager</span><span class="o">.</span><span class="n">get_active_nodes</span><span class="p">()</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">CANMessage</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Register a handler for CAN messages."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Process incoming messages and notify handlers."""</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_manager</span><span class="o">.</span><span class="n">listen</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</code></pre></div>
<h4 id="ip-based-device-implementation">IP-Based Device Implementation<a class="headerlink" href="#ip-based-device-implementation" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/integrations/ip/interface.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrationInterface</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.ip.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPDeviceMessage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IPDeviceIntegration</span><span class="p">(</span><span class="n">IntegrationInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Integration for IP-based devices (e.g., Victron Venus OS)."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize connections to IP devices."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discover_devices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_poll_devices</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Close connections to IP devices."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Send a command to an IP device."""</span>
        <span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"http://</span><span class="si">{</span><span class="n">device</span><span class="p">[</span><span class="s1">'address'</span><span class="p">]</span><span class="si">}</span><span class="s2">/api/v1/setValue"</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">message_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_message_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">IPDeviceMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return an async iterator yielding device status updates."""</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">IPDeviceMessage</span><span class="p">):</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_message_handler</span><span class="p">(</span><span class="n">_handler</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_available_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return a list of available IP devices."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">IPDeviceMessage</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Register a handler for device messages."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_discover_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Discover IP devices on the network."""</span>
        <span class="c1"># Example: scan network, use mDNS, or predefined list</span>
        <span class="n">discovered</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s2">"static_devices"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"static_devices"</span><span class="p">]:</span>
                <span class="n">discovered</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"id"</span><span class="p">:</span> <span class="n">device</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
                    <span class="s2">"address"</span><span class="p">:</span> <span class="n">device</span><span class="p">[</span><span class="s2">"address"</span><span class="p">],</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"ip_device"</span><span class="p">,</span>
                    <span class="s2">"model"</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">,</span> <span class="s2">"unknown"</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="c1"># Implement network discovery here</span>

        <span class="k">return</span> <span class="n">discovered</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_poll_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Poll connected devices for status updates."""</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"http://</span><span class="si">{</span><span class="n">device</span><span class="p">[</span><span class="s1">'address'</span><span class="p">]</span><span class="si">}</span><span class="s2">/api/v1/status"</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="n">IPDeviceMessage</span><span class="p">(</span>
                                <span class="n">source_id</span><span class="o">=</span><span class="n">device</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
                                <span class="n">timestamp</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                <span class="n">raw_data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">,</span> <span class="s2">"unknown"</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error polling device </span><span class="si">{</span><span class="n">device</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"poll_interval"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</code></pre></div>
<h4 id="bluetooth-device-implementation">Bluetooth Device Implementation<a class="headerlink" href="#bluetooth-device-implementation" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/integrations/bluetooth/interface.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrationInterface</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.bluetooth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BluetoothMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.bluetooth.scanner</span><span class="w"> </span><span class="kn">import</span> <span class="n">BluetoothScanner</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BluetoothIntegration</span><span class="p">(</span><span class="n">IntegrationInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Integration for Bluetooth devices."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span> <span class="o">=</span> <span class="n">BluetoothScanner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize Bluetooth scanning."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_loop</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Stop Bluetooth scanning."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Send a message to a Bluetooth device."""</span>
        <span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s2">"address"</span><span class="p">],</span> <span class="n">message_data</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_message_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">BluetoothMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return an async iterator yielding Bluetooth messages."""</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">BluetoothMessage</span><span class="p">):</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_message_handler</span><span class="p">(</span><span class="n">_handler</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_available_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return a list of available Bluetooth devices."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">BluetoothMessage</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Register a handler for Bluetooth messages."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_scan_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Continuously scan for Bluetooth devices."""</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">"id"</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
                    <span class="s2">"address"</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                    <span class="s2">"name"</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">"Unknown"</span><span class="p">,</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"bluetooth"</span><span class="p">,</span>
                    <span class="s2">"rssi"</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">rssi</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span>
            <span class="p">]</span>

            <span class="c1"># Process advertisement data</span>
            <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">advertisement_data</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">BluetoothMessage</span><span class="p">(</span>
                        <span class="n">source_id</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">last_seen</span><span class="p">,</span>
                        <span class="n">raw_data</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">advertisement_data</span><span class="p">,</span>
                        <span class="n">device_name</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">"Unknown"</span><span class="p">,</span>
                        <span class="n">rssi</span><span class="o">=</span><span class="n">device</span><span class="o">.</span><span class="n">rssi</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"scan_interval"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</code></pre></div>
<h3 id="93-integration-factory-and-registry">9.3. Integration Factory and Registry<a class="headerlink" href="#93-integration-factory-and-registry" title="Permanent link">¶</a></h3>
<p>To make it easy to use different integrations:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/integrations/factory.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrationInterface</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.can.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">CANIntegration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.ip.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPDeviceIntegration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.bluetooth.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">BluetoothIntegration</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IntegrationRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Registry of available integration types."""</span>

    <span class="n">_integrations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">IntegrationInterface</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"can"</span><span class="p">:</span> <span class="n">CANIntegration</span><span class="p">,</span>
        <span class="s2">"ip"</span><span class="p">:</span> <span class="n">IPDeviceIntegration</span><span class="p">,</span>
        <span class="s2">"bluetooth"</span><span class="p">:</span> <span class="n">BluetoothIntegration</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_integration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">integration_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">IntegrationInterface</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Register a new integration type."""</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_integrations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">integration_class</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_integration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IntegrationInterface</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Create an integration instance by name."""</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_integrations</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_integrations</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_available_integrations</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">IntegrationInterface</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Get all registered integration types."""</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_integrations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div>
<h2 id="10-example-implementations">10. Example Implementations<a class="headerlink" href="#10-example-implementations" title="Permanent link">¶</a></h2>
<h3 id="101-new-maintenance-service-example">10.1. New Maintenance Service Example<a class="headerlink" href="#101-new-maintenance-service-example" title="Permanent link">¶</a></h3>
<p>As an example of how the new architecture would accommodate a coach maintenance tracking feature:</p>
<h4 id="models">Models<a class="headerlink" href="#models" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/models/maintenance.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaintenanceItemType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Types of maintenance items."""</span>
    <span class="n">SCHEDULED</span> <span class="o">=</span> <span class="s2">"scheduled"</span>
    <span class="n">MILEAGE</span> <span class="o">=</span> <span class="s2">"mileage"</span>
    <span class="n">ENGINE_HOURS</span> <span class="o">=</span> <span class="s2">"engine_hours"</span>
    <span class="n">CALENDAR</span> <span class="o">=</span> <span class="s2">"calendar"</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaintenanceStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Status of a maintenance item."""</span>
    <span class="n">UPCOMING</span> <span class="o">=</span> <span class="s2">"upcoming"</span>
    <span class="n">DUE</span> <span class="o">=</span> <span class="s2">"due"</span>
    <span class="n">OVERDUE</span> <span class="o">=</span> <span class="s2">"overdue"</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">"completed"</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaintenanceItem</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represents a maintenance item to be tracked."""</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">MaintenanceItemType</span>
    <span class="n">interval_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">interval_unit</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># days, miles, hours, months</span>
    <span class="n">last_performed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># miles or hours when last performed</span>
    <span class="n">next_due_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">next_due_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># miles or hours</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">MaintenanceStatus</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">UPCOMING</span>
    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">custom_fields</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaintenanceRecord</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Record of a completed maintenance task."""</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">completion_date</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">value_at_completion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># miles or hours</span>
    <span class="n">technician</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cost</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">attachments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</code></pre></div>
<h4 id="service">Service<a class="headerlink" href="#service" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/services/maintenance/schedule_service.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.models.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MaintenanceItem</span><span class="p">,</span>
    <span class="n">MaintenanceRecord</span><span class="p">,</span>
    <span class="n">MaintenanceStatus</span><span class="p">,</span>
    <span class="n">MaintenanceItemType</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_state_value</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.entity_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_entity_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaintenanceScheduleService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Service for managing maintenance schedules."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MaintenanceItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MaintenanceRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">MaintenanceItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MaintenanceItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add a new maintenance item to track."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_item_status</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MaintenanceItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get a maintenance item by ID."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MaintenanceItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get all maintenance items."""</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_due_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MaintenanceItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get all items that are due or overdue."""</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">DUE</span><span class="p">,</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">OVERDUE</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">MaintenanceRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MaintenanceRecord</span><span class="p">,</span> <span class="n">MaintenanceItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Add a new maintenance record and update the item status."""</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Maintenance item </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">item_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">item_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="c1"># Update the maintenance item</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">item_id</span><span class="p">]</span>
        <span class="n">item</span><span class="o">.</span><span class="n">last_performed</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">completion_date</span>

        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">value_at_completion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">last_value</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">value_at_completion</span>

        <span class="c1"># Recalculate next due date/value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_item_status</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">item_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">record</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">item_id</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MaintenanceRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get all maintenance records for an item."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_item_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update the status of a maintenance item."""</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MaintenanceItemType</span><span class="o">.</span><span class="n">SCHEDULED</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">last_performed</span><span class="p">:</span>
                <span class="c1"># Never performed, set to upcoming</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">UPCOMING</span>
                <span class="k">return</span>

            <span class="c1"># Calculate next due date based on interval</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">interval_unit</span> <span class="o">==</span> <span class="s2">"days"</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">next_due_date</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">last_performed</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">interval_value</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">interval_unit</span> <span class="o">==</span> <span class="s2">"months"</span><span class="p">:</span>
                <span class="c1"># Simple month calculation (not exact)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">next_due_date</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">last_performed</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">interval_value</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

            <span class="c1"># Determine status based on due date</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">next_due_date</span> <span class="o">&lt;=</span> <span class="n">today</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">OVERDUE</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">next_due_date</span> <span class="o">-</span> <span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># Within a week</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">DUE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">UPCOMING</span>

        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MaintenanceItemType</span><span class="o">.</span><span class="n">MILEAGE</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">last_value</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">UPCOMING</span>
                <span class="k">return</span>

            <span class="c1"># Get current mileage from entity</span>
            <span class="n">current_mileage</span> <span class="o">=</span> <span class="n">get_entity_value</span><span class="p">(</span><span class="s2">"vehicle"</span><span class="p">,</span> <span class="s2">"odometer"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Calculate next due mileage</span>
            <span class="n">item</span><span class="o">.</span><span class="n">next_due_value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">last_value</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">interval_value</span>

            <span class="c1"># Determine status based on mileage</span>
            <span class="k">if</span> <span class="n">current_mileage</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="o">.</span><span class="n">next_due_value</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">OVERDUE</span>
            <span class="k">elif</span> <span class="n">current_mileage</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">next_due_value</span> <span class="o">-</span> <span class="mi">500</span><span class="p">):</span>  <span class="c1"># Within 500 miles</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">DUE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MaintenanceStatus</span><span class="o">.</span><span class="n">UPCOMING</span>

        <span class="c1"># Similar logic for ENGINE_HOURS and CALENDAR types</span>
</code></pre></div>
<h4 id="api-router">API Router<a class="headerlink" href="#api-router" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/api/routers/maintenance.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.maintenance.schedule_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaintenanceScheduleService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.models.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaintenanceItem</span><span class="p">,</span> <span class="n">MaintenanceRecord</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">"/api/maintenance"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">"Maintenance"</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_maintenance_service</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Dependency injection for the maintenance service."""</span>
    <span class="k">return</span> <span class="n">MaintenanceScheduleService</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/items"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">MaintenanceItem</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_maintenance_items</span><span class="p">(</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">MaintenanceScheduleService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_maintenance_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get all maintenance items."""</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">get_all_items</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/items/due"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">MaintenanceItem</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_due_items</span><span class="p">(</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">MaintenanceScheduleService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_maintenance_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get maintenance items that are due or overdue."""</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">get_due_items</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/items/</span><span class="si">{item_id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">MaintenanceItem</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_maintenance_item</span><span class="p">(</span>
    <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">MaintenanceScheduleService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_maintenance_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get a specific maintenance item."""</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Maintenance item not found"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">item</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/items"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">MaintenanceItem</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_maintenance_item</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">MaintenanceItem</span><span class="p">,</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">MaintenanceScheduleService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_maintenance_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create a new maintenance item."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/records/</span><span class="si">{item_id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">MaintenanceRecord</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_maintenance_records</span><span class="p">(</span>
    <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">MaintenanceScheduleService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_maintenance_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get maintenance records for a specific item."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">service</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Maintenance item not found"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/records"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">MaintenanceRecord</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_maintenance_record</span><span class="p">(</span>
    <span class="n">record</span><span class="p">:</span> <span class="n">MaintenanceRecord</span><span class="p">,</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">MaintenanceScheduleService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_maintenance_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create a new maintenance record."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">saved_record</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">saved_record</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div>
<h3 id="102-main-application-integration">10.2. Main Application Integration<a class="headerlink" href="#102-main-application-integration" title="Permanent link">¶</a></h3>
<p>Here's an example of how the main application would initialize and integrate all components:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># backend/main.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">get_settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.core.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventBus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.middleware.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">metrics_middleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.feature_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureManager</span><span class="p">,</span> <span class="n">get_feature_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.api.routers</span><span class="w"> </span><span class="kn">import</span> <span class="n">entities</span><span class="p">,</span> <span class="n">can</span><span class="p">,</span> <span class="n">websocket</span><span class="p">,</span> <span class="n">maintenance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrationRegistry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.feature_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">backend.core.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_metrics</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FastAPI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create and configure the FastAPI application."""</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">app_description</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">app_version</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Configure middleware</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
        <span class="n">CORSMiddleware</span><span class="p">,</span>
        <span class="n">allow_origins</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">cors_origins</span><span class="p">,</span>
        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
        <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">"http"</span><span class="p">)(</span><span class="n">metrics_middleware</span><span class="p">)</span>

    <span class="c1"># Configure exception handlers</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generic_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">"Unhandled exception"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">"detail"</span><span class="p">:</span> <span class="s2">"Internal server error"</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="c1"># Register API routers</span>
    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">can</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">websocket</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>

    <span class="c1"># Initialize feature manager with dependency injection</span>
    <span class="n">feature_manager</span> <span class="o">=</span> <span class="n">get_feature_manager</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

    <span class="c1"># Register feature-dependent routers conditionally</span>
    <span class="k">if</span> <span class="n">feature_manager</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="s2">"maintenance_tracking"</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">maintenance</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>

    <span class="c1"># Setup metrics</span>
    <span class="n">setup_metrics</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_background_tasks</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Start background tasks for the application."""</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">integrations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize each configured integration</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">IntegrationRegistry</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">integration_config</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">integrations</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">integration_config</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">integration_config</span><span class="p">[</span><span class="s2">"config"</span><span class="p">]</span>

        <span class="n">integration</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">create_integration</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integration</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">integration</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
            <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">integrations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">integration</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Initialized </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> integration"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to create integration: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Initialize application state</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">app_state</span> <span class="o">=</span> <span class="n">AppState</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">app_state</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># Connect integrations to message handlers</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">integration</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">integrations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"can"</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.can.processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_can_message</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">register_message_handler</span><span class="p">(</span><span class="n">process_can_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"ip"</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.ip.processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_ip_message</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">register_message_handler</span><span class="p">(</span><span class="n">process_ip_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"bluetooth"</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">backend.integrations.bluetooth.processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_bluetooth_message</span>
            <span class="n">integration</span><span class="o">.</span><span class="n">register_message_handler</span><span class="p">(</span><span class="n">process_bluetooth_message</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown_background_tasks</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Shutdown background tasks for the application."""</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">integration</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">integrations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">integration</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Shutdown </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> integration"</span><span class="p">)</span>

    <span class="c1"># Clean up application state</span>
    <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">app_state</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup_event</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Run startup tasks."""</span>
    <span class="k">await</span> <span class="n">start_background_tasks</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Application startup complete"</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"shutdown"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown_event</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Run shutdown tasks."""</span>
    <span class="k">await</span> <span class="n">shutdown_background_tasks</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Application shutdown complete"</span><span class="p">)</span>
</code></pre></div>
<h2 id="11-detailed-migration-plan">11. Detailed Migration Plan<a class="headerlink" href="#11-detailed-migration-plan" title="Permanent link">¶</a></h2>
<h3 id="111-expanded-file-migration-path">11.1. Expanded File Migration Path<a class="headerlink" href="#111-expanded-file-migration-path" title="Permanent link">¶</a></h3>
<p>The following details the specific migration path for each file, with additional details on handling dependencies and refactoring considerations.</p>
<h4 id="common-models">Common Models<a class="headerlink" href="#common-models" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/common/models.py</code></li>
<li><strong>Target</strong>: <code>backend/models/common.py</code></li>
<li><strong>Dependencies</strong>: Minimal (Pydantic)</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/models/common.py</code></li>
<li>Copy content, update imports if needed</li>
<li>Verify imports continue to work in both old and new locations</li>
<li>Consider adding a deprecation warning in the original file</li>
</ul>
<h4 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/config.py</code></li>
<li><strong>Target</strong>: <code>backend/core/config.py</code></li>
<li><strong>Dependencies</strong>: Minimal</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/core/config.py</code></li>
<li>Copy content, ensuring any absolute paths are updated</li>
<li>Add any new configuration options for the refactored structure</li>
<li>Consider compatibility for transition period</li>
</ul>
<h4 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/metrics.py</code></li>
<li><strong>Target</strong>: <code>backend/core/metrics.py</code></li>
<li><strong>Dependencies</strong>: Minimal</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/core/metrics.py</code></li>
<li>Copy content with minimal changes</li>
<li>Consider enhancing with service-specific metrics</li>
</ul>
<h4 id="rv-c-decoder">RV-C Decoder<a class="headerlink" href="#rv-c-decoder" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/rvc_decoder/*</code></li>
<li><strong>Target</strong>: <code>backend/integrations/rvc/*</code></li>
<li><strong>Dependencies</strong>: <code>common.models</code></li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/integrations/rvc/</code> directory</li>
<li>Copy all files, updating imports to use <code>backend/models/common</code></li>
<li>Create clear interface boundaries with other components</li>
</ul>
<h4 id="domain-specific-models">Domain-Specific Models<a class="headerlink" href="#domain-specific-models" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/models.py</code></li>
<li><strong>Target</strong>: Multiple model files:</li>
<li><code>backend/models/entities.py</code></li>
<li><code>backend/models/can.py</code></li>
<li><code>backend/models/github.py</code></li>
<li><strong>Dependencies</strong>: <code>common.models</code></li>
<li><strong>Migration Steps</strong>:</li>
<li>Create each target file</li>
<li>Carefully split models by domain</li>
<li>Update imports across files for split models</li>
<li>Create compatibility layer for transition period</li>
</ul>
<h4 id="can-manager">CAN Manager<a class="headerlink" href="#can-manager" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/can_manager.py</code></li>
<li><strong>Target</strong>: <code>backend/integrations/can/manager.py</code></li>
<li><strong>Dependencies</strong>: Several</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/integrations/can/manager.py</code></li>
<li>Create <code>backend/integrations/can/interface.py</code> implementing <code>IntegrationInterface</code></li>
<li>Adapt manager class to work with the new interface</li>
<li>Preserve existing functionality during transition</li>
</ul>
<h4 id="events-broker-new">Events Broker (New)<a class="headerlink" href="#events-broker-new" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Target</strong>: <code>backend/core/events.py</code></li>
<li><strong>Purpose</strong>: Break circular dependencies between app_state and websocket</li>
<li><strong>Implementation Steps</strong>:</li>
<li>Create event broker system with publish/subscribe pattern</li>
<li>Extract shared functionality from app_state and websocket</li>
<li>Update both modules to use the event broker instead of direct imports</li>
</ul>
<h4 id="application-state">Application State<a class="headerlink" href="#application-state" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/app_state.py</code></li>
<li><strong>Target</strong>: <code>backend/core/state.py</code></li>
<li><strong>Dependencies</strong>: Several, including circular dependency with websocket</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create events broker first</li>
<li>Create <code>backend/core/state.py</code> with dependency on events broker</li>
<li>Refactor to reduce coupling with other components</li>
<li>Implement proper service interfaces</li>
</ul>
<h4 id="websocket-handling">WebSocket Handling<a class="headerlink" href="#websocket-handling" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/websocket.py</code></li>
<li><strong>Target</strong>: <code>backend/websocket/handlers.py</code></li>
<li><strong>Dependencies</strong>: Several, including circular dependency with app_state</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/websocket/handlers.py</code> using events broker</li>
<li>Extract business logic to appropriate services</li>
<li>Implement clear API for message broadcasting</li>
</ul>
<h4 id="api-routers">API Routers<a class="headerlink" href="#api-routers" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/api_routers/*.py</code></li>
<li><strong>Target</strong>: <code>backend/api/routers/*.py</code></li>
<li><strong>Dependencies</strong>: Many</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create service modules first</li>
<li>Extract business logic from routers to services</li>
<li>Create new router files with slimmer implementation</li>
<li>Ensure backward compatibility during transition</li>
</ul>
<h4 id="feature-manager-service">Feature Manager Service<a class="headerlink" href="#feature-manager-service" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/feature_manager.py</code>, <code>src/core_daemon/feature_base.py</code></li>
<li><strong>Target</strong>: <code>backend/services/feature_manager.py</code>, <code>backend/services/feature_base.py</code></li>
<li><strong>Dependencies</strong>: Core, Events Broker, Settings</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/services/feature_base.py</code> with enhanced <code>Feature</code> base class:<ul>
<li>Add dependency management between features</li>
<li>Improve type safety and async support</li>
<li>Maintain health reporting capabilities</li>
<li>Add proper documentation for overridable methods</li>
<li>Implement standardized health status reporting</li>
</ul>
</li>
<li>Create <code>backend/services/feature_manager.py</code> as a proper service class:<ul>
<li>Implement <code>FeatureManager</code> class with dependency injection support</li>
<li>Add methods for feature flag checking (<code>is_enabled</code>)</li>
<li>Add enhanced methods for feature querying and management</li>
<li>Implement topological sorting for dependency resolution</li>
<li>Integrate with the events system for feature state changes</li>
<li>Connect feature flags to application settings</li>
<li>Maintain existing feature registration and lifecycle management</li>
</ul>
</li>
<li>Create FastAPI dependency function for service injection</li>
<li>Implement integration with settings system for feature flags</li>
<li>Update references to use the new service-based API</li>
<li>Add example modules like maintenance tracking that use the feature flag system</li>
</ul>
<h4 id="middleware">Middleware<a class="headerlink" href="#middleware" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/middleware.py</code></li>
<li><strong>Target</strong>: <code>backend/middleware/http.py</code></li>
<li><strong>Dependencies</strong>: Metrics</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create <code>backend/middleware/http.py</code></li>
<li>Update imports for metrics</li>
<li>Consider adding other middleware modules as needed</li>
</ul>
<h4 id="main-application">Main Application<a class="headerlink" href="#main-application" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Source</strong>: <code>src/core_daemon/main.py</code></li>
<li><strong>Target</strong>: <code>backend/main.py</code></li>
<li><strong>Dependencies</strong>: All components</li>
<li><strong>Migration Steps</strong>:</li>
<li>Create new main.py after other modules are migrated</li>
<li>Implement cleaner initialization logic</li>
<li>Add support for integration registry</li>
<li>Add feature flag checks for optional routers</li>
<li>Implement robust startup/shutdown procedures</li>
</ul>
<h3 id="112-dependency-resolution-strategy">11.2. Dependency Resolution Strategy<a class="headerlink" href="#112-dependency-resolution-strategy" title="Permanent link">¶</a></h3>
<p>To handle complex dependencies, the following strategies will be used:</p>
<ol>
<li><strong>Bottom-Up Migration</strong>: Start with least dependent files</li>
<li><strong>Interface Abstraction</strong>: Create clean interfaces between components</li>
<li><strong>Events Broker</strong>: Implement publish/subscribe patterns for cross-component communication</li>
<li><strong>Service Layer</strong>: Extract business logic into dedicated services</li>
<li><strong>Dependency Injection</strong>: Use FastAPI's dependency system where appropriate</li>
<li><strong>Staged Deployment</strong>: Maintain compatibility during transition period</li>
</ol>
<h2 id="12-updated-execution-checklist">12. Updated Execution Checklist<a class="headerlink" href="#12-updated-execution-checklist" title="Permanent link">¶</a></h2>
<h3 id="121-preparation-phase-week-1">12.1. Preparation Phase (Week 1)<a class="headerlink" href="#121-preparation-phase-week-1" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Create the new directory structure</li>
<li>[ ] Create interface definitions in <code>backend/integrations/interfaces.py</code></li>
<li>[ ] Create events broker in <code>backend/core/events.py</code></li>
<li>[ ] Set up comprehensive testing plan</li>
<li>[ ] Document migration strategy for the team</li>
<li>[ ] Create compatibility layer plan</li>
<li>[ ] Develop rollback procedures</li>
</ul>
<h3 id="122-foundation-phase-week-1-2">12.2. Foundation Phase (Week 1-2)<a class="headerlink" href="#122-foundation-phase-week-1-2" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Migrate core foundational modules:</li>
<li>[ ] <code>src/common/models.py</code> → <code>backend/models/common.py</code></li>
<li>[ ] <code>src/core_daemon/config.py</code> → <code>backend/core/config.py</code></li>
<li>[ ] <code>src/core_daemon/metrics.py</code> → <code>backend/core/metrics.py</code></li>
<li>[ ] Create integration interfaces for CAN, IP, and Bluetooth</li>
<li>[ ] Create integration factory and registry</li>
<li>[ ] Migrate <code>src/rvc_decoder/*</code> → <code>backend/integrations/rvc/*</code></li>
<li>[ ] Create tests for all migrated modules</li>
</ul>
<h3 id="123-core-components-phase-week-2-3">12.3. Core Components Phase (Week 2-3)<a class="headerlink" href="#123-core-components-phase-week-2-3" title="Permanent link">¶</a></h3>
<ul>
<li>[x] Split domain-specific models:</li>
<li>[x] Create <code>backend/models/entities.py</code>, <code>backend/models/can.py</code>, etc.</li>
<li>[x] Update imports in dependent files</li>
<li>[x] Create compatibility imports</li>
<li>[x] Migrate middleware:</li>
<li>[x] <code>src/core_daemon/middleware.py</code> → <code>backend/middleware/http.py</code></li>
<li>[x] Migrate CAN integration:</li>
<li>[x] <code>src/core_daemon/can_manager.py</code> → <code>backend/integrations/can/manager.py</code></li>
<li>[x] Create <code>backend/integrations/can/interface.py</code> implementing <code>IntegrationInterface</code></li>
<li>[x] Create initial service layer:</li>
<li>[x] <code>backend/services/entity_service.py</code></li>
<li>[x] <code>backend/services/can_service.py</code></li>
<li>[x] Create enhanced feature management:</li>
<li>[x] Create <code>backend/services/feature_base.py</code> with improved Feature base class</li>
<li>[x] Create <code>backend/services/feature_manager.py</code> with FeatureManager service class</li>
<li>[x] Add <code>backend/services/feature_flags.yaml</code> for config-driven feature definitions</li>
<li>[x] Require all feature logic and registration to use the new FeatureManager/Feature/YAML pattern</li>
<li>[x] Remove legacy feature flag code and update all imports to use new backend module paths</li>
<li>[x] Update documentation and OpenAPI specs to reflect feature-conditional endpoints</li>
<li>[x] Add feature dependency resolution logic</li>
<li>[x] Create tests for all migrated components (to be expanded in later phases)</li>
</ul>
<p><em>Phase 2 complete: All core service skeletons, feature management, and migration to the new backend structure are done. Proceed to Phase 3 for state, API, and integration migration.</em></p>
<h3 id="124-state-and-api-phase-week-3-4">12.4. State and API Phase (Week 3-4)<a class="headerlink" href="#124-state-and-api-phase-week-3-4" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Migrate state management:</li>
<li>[ ] <code>src/core_daemon/app_state.py</code> → <code>backend/core/state.py</code></li>
<li>[ ] Integrate with events broker</li>
<li>[ ] Extract service methods to appropriate services</li>
<li>[ ] Migrate WebSocket handling:</li>
<li>[ ] <code>src/core_daemon/websocket.py</code> → <code>backend/websocket/handlers.py</code></li>
<li>[ ] Integrate with events broker</li>
<li>[ ] Migrate API routers:</li>
<li>[ ] Extract business logic to services</li>
<li>[ ] Create new router files with service dependencies</li>
<li>[ ] Ensure backward compatibility</li>
<li>[ ] Migrate feature management:</li>
<li>[ ] <code>src/core_daemon/feature_manager.py</code> → <code>backend/services/feature_manager.py</code></li>
<li>[ ] Create tests for all migrated components</li>
</ul>
<h3 id="125-main-application-phase-week-4-5">12.5. Main Application Phase (Week 4-5)<a class="headerlink" href="#125-main-application-phase-week-4-5" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Create new main application:</li>
<li>[ ] <code>backend/main.py</code> with clean initialization</li>
<li>[ ] Configure router registration based on features</li>
<li>[ ] Implement integration registration</li>
<li>[ ] Setup startup/shutdown procedures</li>
<li>[ ] Run full integration tests</li>
<li>[ ] Create comprehensive documentation</li>
<li>[ ] Validate backward compatibility</li>
</ul>
<h3 id="126-new-features-phase-week-5">12.6. New Features Phase (Week 5+)<a class="headerlink" href="#126-new-features-phase-week-5" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Develop coach maintenance tracking:</li>
<li>[ ] Create models, services, and API endpoints</li>
<li>[ ] Integrate with existing state management</li>
<li>[ ] Add feature flag for enabling/disabling</li>
<li>[ ] Implement IP device integration:</li>
<li>[ ] Create concrete implementation of <code>IntegrationInterface</code></li>
<li>[ ] Develop device discovery and messaging</li>
<li>[ ] Implement Bluetooth integration:</li>
<li>[ ] Create concrete implementation of <code>IntegrationInterface</code></li>
<li>[ ] Develop device scanning and communication</li>
</ul>
<h3 id="127-transition-and-cleanup-ongoing">12.7. Transition and Cleanup (Ongoing)<a class="headerlink" href="#127-transition-and-cleanup-ongoing" title="Permanent link">¶</a></h3>
<ul>
<li>[ ] Update imports across codebase to use new modules</li>
<li>[ ] Remove compatibility layers once no longer needed</li>
<li>[ ] Deprecate old code paths with clear warnings</li>
<li>[ ] Update testing infrastructure</li>
<li>[ ] Update CI/CD pipelines</li>
<li>[ ] Update documentation to reflect new architecture</li>
</ul>
<h2 id="13-conclusion-and-technical-benefits">13. Conclusion and Technical Benefits<a class="headerlink" href="#13-conclusion-and-technical-benefits" title="Permanent link">¶</a></h2>
<p>This refactoring will lead to several key technical improvements:</p>
<ol>
<li><strong>Modularity</strong>: Clear separation of concerns makes the codebase easier to understand and modify</li>
<li><strong>Extensibility</strong>: New integrations and features can be added without modifying existing code</li>
<li><strong>Testability</strong>: Clearer interfaces make it easier to write isolated unit tests</li>
<li><strong>Maintainability</strong>: Business logic in services is easier to understand and maintain</li>
<li><strong>Scalability</strong>: Components can be improved independently as needs evolve</li>
<li><strong>Developer Experience</strong>: Clearer structure makes onboarding and development more efficient</li>
</ol>
<p>By focusing on clean interfaces, dependency injection, and service-oriented patterns, this refactoring lays the groundwork for future feature development while improving the quality and maintainability of the codebase.</p>
<h2 id="14-feature-management-best-practices">14. Feature Management Best Practices<a class="headerlink" href="#14-feature-management-best-practices" title="Permanent link">¶</a></h2>
<p>Based on research into modern FastAPI feature management patterns, the refactoring will incorporate the following best practices:</p>
<h3 id="141-feature-flag-architecture">14.1. Feature Flag Architecture<a class="headerlink" href="#141-feature-flag-architecture" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Service-Based Pattern</strong>: Implement feature management as a dedicated service with dependency injection</li>
<li><strong>Feature Classes</strong>: Use an enhanced base class with clear lifecycle methods and health reporting</li>
<li><strong>Dependency Management</strong>: Explicitly declare dependencies between features</li>
<li><strong>Async Support</strong>: Ensure non-blocking, async-aware implementation throughout</li>
</ul>
<h3 id="142-feature-flag-implementation">14.2. Feature Flag Implementation<a class="headerlink" href="#142-feature-flag-implementation" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Example of the enhanced feature manager service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Feature</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">core</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dependencies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Called when the feature is started."""</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Called when the feature is stopped."""</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Report health status."""</span>
        <span class="k">return</span> <span class="s2">"unknown"</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FeatureManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">:</span> <span class="n">Feature</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">feature</span><span class="o">.</span><span class="n">enabled</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Start all enabled features in dependency order."""</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ordered_features</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">feature</span><span class="o">.</span><span class="n">startup</span><span class="p">()</span>
</code></pre></div>
<h3 id="143-usage-in-fastapi-endpoints">14.3. Usage in FastAPI Endpoints<a class="headerlink" href="#143-usage-in-fastapi-endpoints" title="Permanent link">¶</a></h3>
<p>Best practices for using feature flags in the API layer:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Example router with feature flag check</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">backend.services.feature_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureManager</span><span class="p">,</span> <span class="n">get_feature_manager</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/maintenance/status"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_maintenance_status</span><span class="p">(</span>
    <span class="n">feature_manager</span><span class="p">:</span> <span class="n">FeatureManager</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_feature_manager</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get maintenance system status."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_manager</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="s2">"maintenance_tracking"</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Maintenance tracking not enabled"</span><span class="p">)</span>

    <span class="c1"># Continue with maintenance status logic</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"operational"</span><span class="p">}</span>
</code></pre></div>
<h3 id="144-integration-with-settings-and-configuration">14.4. Integration with Settings and Configuration<a class="headerlink" href="#144-integration-with-settings-and-configuration" title="Permanent link">¶</a></h3>
<p>The feature manager will integrate with the application's settings system to allow:
- Environment variable-based feature enabling/disabling
- Configuration file-based feature settings
- Per-environment feature profiles</p>
<h3 id="145-feature-health-monitoring">14.5. Feature Health Monitoring<a class="headerlink" href="#145-feature-health-monitoring" title="Permanent link">¶</a></h3>
<p>Features will report health status through the enhanced health check endpoint:
- Each feature provides its own health status
- System aggregates feature health for overall status
- Unhealthy features are highlighted in monitoring</p>
<h2 id="15-references">15. References<a class="headerlink" href="#15-references" title="Permanent link">¶</a></h2>
<ul>
<li><a href="https://fastapi.tiangolo.com/tutorial/bigger-applications/">FastAPI Project Structure</a></li>
<li><a href="https://realpython.com/python-application-layouts/">Python Application Layouts</a></li>
<li><a href="https://www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/">Clean Architecture in Python</a></li>
<li><a href="https://fastapi.tiangolo.com/tutorial/dependencies/">Dependency Injection in FastAPI</a></li>
<li><a href="https://launchdarkly.com/blog/best-practices-feature-flags/">Feature Flag Best Practices</a></li>
<li><a href="https://www.gridlinesapp.com/blog/building-maintainable-fastapi-services-a-feature-driven-approach">Feature-Driven FastAPI Services</a></li>
<li>Current <code>docs/architecture/backend.md</code> documentation</li>
<li><a href="https://www.oreilly.com/library/view/software-architecture-patterns/9781491971437/ch02.html">Event-Driven Architecture Patterns</a></li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
</body>
</html>