<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rvc2api UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <header class="bg-gray-800 shadow p-4 text-xl font-semibold flex items-center justify-between">
      <span>rvc2api Dashboard</span>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Collapsible Sidebar -->
      <aside id="sidebar" class="w-64 bg-gray-800 p-4 space-y-4 border-r border-gray-700 transition-all duration-300">
        <div class="flex justify-between items-center mb-4">
          <span class="text-lg font-semibold">Filters</span>
          <button id="toggleSidebar" class="text-gray-400 hover:text-gray-100">
            <i class="mdi mdi-chevron-left"></i>
          </button>
        </div>
        <div>
          <label class="block mb-2 text-sm text-gray-300">
            <i class="mdi mdi-filter-variant mr-1"></i>Filter by Area:
          </label>
          <select id="area-filter" class="block w-full bg-gray-900 text-gray-100 border border-gray-700 rounded p-2">
            <option value="All">All</option>
          </select>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 overflow-y-auto p-6">
        <h1 class="text-3xl font-bold mb-6">RV-C Lights</h1>
        <div id="light-grid" class="space-y-8">
          <!-- Grouped lights will be injected here -->
        </div>
      </main>
    </div>

    <script>
      const socket = new WebSocket(`ws://${location.host}/ws`);
      const grid = document.getElementById('light-grid');
      const filter = document.getElementById('area-filter');
      const sidebar = document.getElementById('sidebar');
      const toggleSidebarBtn = document.getElementById('toggleSidebar');
      const lightStates = {};
      const debounceTimers = {};

      toggleSidebarBtn.addEventListener('click', () => {
        sidebar.classList.toggle('w-64');
        sidebar.classList.toggle('w-0');
        sidebar.classList.toggle('p-4');
        toggleSidebarBtn.querySelector('i').classList.toggle('mdi-chevron-left');
        toggleSidebarBtn.querySelector('i').classList.toggle('mdi-chevron-right');
      });

      function getCardColor(brightness, isOn) {
        if (!isOn) return 'bg-gray-800';
        const alpha = brightness / 100;
        return `bg-[rgba(234,179,8,${alpha.toFixed(2)})] text-black`;
      }

      function prettifyName(name) {
        return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      }

      function renderCard(entity) {
        const { entity_id, state, value, raw, capabilities = [], friendly_name } = entity;
        const brightness = raw?.operating_status ?? 0;
        const brightnessUI = Math.round(brightness / 2);
        const isOn = state === 'on';
        const colorClass = getCardColor(brightnessUI, isOn);
        const prettyName = friendly_name || prettifyName(entity_id);

        const card = document.createElement('div');
        card.className = `rounded-2xl p-4 shadow transition-colors duration-300 ${colorClass} relative group`;
        card.style.cursor = 'pointer';
        card.id = entity_id;
        card.innerHTML = `
          <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <i class="mdi mdi-power text-yellow-400"></i>
          </div>
          <h2 class="text-xl font-semibold mb-2">${prettyName}</h2>
          <p class="mb-2 flex items-center"><i class="mdi ${isOn ? 'mdi-lightbulb-on' : 'mdi-lightbulb-off'} mr-1"></i><strong>${state}</strong></p>
          <p class="mb-2 flex items-center"><i class="mdi mdi-brightness-6 mr-1"></i>${brightnessUI}%</p>
          ${capabilities.includes('brightness') ? `<input type="range" min="0" max="100" value="${brightnessUI}" class="w-full slider" />` : ''}
        `;

        card.addEventListener('click', (e) => {
          if (e.target.tagName === 'INPUT') return;
          fetch(`/entities/${entity_id}/control`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: 'toggle' })
          });
        });

        const slider = card.querySelector('input');
        if (slider) {
          slider.addEventListener('input', (e) => {
            const level = parseInt(e.target.value);
            clearTimeout(debounceTimers[entity_id]);
            debounceTimers[entity_id] = setTimeout(() => {
              fetch(`/entities/${entity_id}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: 'set', state: 'on', brightness: level })
              });
            }, 250);
          });
        }

        return card;
      }

      function renderGroupedLights() {
        grid.innerHTML = '';
        const selected = filter.value;
        const grouped = {};

        for (const entity of Object.values(lightStates)) {
          const area = entity?.suggested_area || entity?.area || entity?.value?.suggested_area || 'Unknown';
          if (selected !== 'All' && selected !== area) continue;
          if (!grouped[area]) grouped[area] = [];
          grouped[area].push(entity);
        }

        const sortedAreas = Object.keys(grouped).sort();
        for (const area of sortedAreas) {
          const section = document.createElement('div');
          section.innerHTML = `
            <h2 class="text-2xl font-bold mb-1">${area}</h2>
            <div class="border-t border-gray-600 my-2"></div>
            <h3 class="text-xl font-semibold mb-4 flex items-center"><i class="mdi mdi-lightbulb-outline mr-2"></i>Lights</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
          `;
          const sectionGrid = section.querySelector('div.grid');

          grouped[area].sort((a, b) => a.entity_id.localeCompare(b.entity_id)).forEach(entity => {
            sectionGrid.appendChild(renderCard(entity));
          });

          grid.appendChild(section);
        }
      }

      filter.addEventListener('change', renderGroupedLights);

      socket.onmessage = (event) => {
        const payload = JSON.parse(event.data);
        if (!payload.entity_id) return;
        lightStates[payload.entity_id] = payload;
        renderGroupedLights();
      };

      fetch('/lights')
        .then((res) => res.json())
        .then((data) => {
          for (const entity of Object.values(data)) {
            lightStates[entity.entity_id] = entity;
          }

          const areas = new Set(Object.values(lightStates).map(e => e?.suggested_area || e?.area || e?.value?.suggested_area || 'Unknown'));
          for (const area of [...areas].sort()) {
            const opt = document.createElement('option');
            opt.value = area;
            opt.textContent = area;
            filter.appendChild(opt);
          }

          renderGroupedLights();
        });
    </script>
  </body>
</html>
