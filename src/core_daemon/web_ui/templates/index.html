<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RV-C Light Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x" defer></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-6">RV-C Light Dashboard</h1>
    <div id="lights" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Light controls will be dynamically populated here -->
    </div>
  </div>

  <script>
    const socket = new WebSocket(`ws://${location.host}/ws`);
    const lightsContainer = document.getElementById('lights');
    const lightState = {};

    socket.addEventListener('message', event => {
      const data = JSON.parse(event.data);
      if (!data.entity_id || !data.raw?.hasOwnProperty('operating_status')) return;

      lightState[data.entity_id] = data;
      renderLights();
    });

    async function toggleLight(entityId) {
      const current = lightState[entityId];
      const command = {
        command: 'toggle'
      };
      await fetch(`/entities/${entityId}/control`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(command)
      });
    }

    async function setBrightness(entityId, brightness) {
      const command = {
        command: 'set',
        state: brightness > 0 ? 'on' : 'off',
        brightness
      };
      await fetch(`/entities/${entityId}/control`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(command)
      });
    }

    function renderLights() {
      lightsContainer.innerHTML = '';
      for (const [entityId, data] of Object.entries(lightState)) {
        const brightness = Math.round((data.raw.operating_status || 0) / 2);
        const isOn = brightness > 0;

        const lightCard = document.createElement('div');
        lightCard.className = 'bg-gray-800 p-4 rounded-xl shadow flex flex-col gap-3';

        lightCard.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-lg font-semibold">${entityId}</h2>
              <p class="text-sm text-gray-400">${isOn ? 'On' : 'Off'} - ${brightness}%</p>
            </div>
            <button
              class="px-4 py-1 rounded bg-${isOn ? 'red' : 'green'}-600 hover:bg-${isOn ? 'red' : 'green'}-700"
              onclick="toggleLight('${entityId}')"
            >
              ${isOn ? 'Off' : 'On'}
            </button>
          </div>
          <input
            type="range"
            min="0" max="100" step="1"
            value="${brightness}"
            oninput="setBrightness('${entityId}', this.value)"
            class="w-full accent-yellow-500"
          />
        `;

        lightsContainer.appendChild(lightCard);
      }
    }
  </script>
</body>
</html>
