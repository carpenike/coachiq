<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rvc2api UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <header class="bg-gray-800 shadow p-4 text-xl font-semibold flex items-center justify-between">
      <span>rvc2api Dashboard</span>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside id="sidebar" class="w-64 bg-gray-800 p-4 space-y-4 border-r border-gray-700 transition-all duration-300 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <span class="text-lg font-semibold">Navigation</span>
          <button id="toggleSidebar" class="text-gray-400 hover:text-gray-100">
            <i class="mdi mdi-chevron-left"></i>
          </button>
        </div>
        <nav class="space-y-2">
          <button data-view="lights" class="nav-link w-full text-left text-gray-300 hover:text-white">Lights</button>
          <button data-view="logs" class="nav-link w-full text-left text-gray-300 hover:text-white">Logs</button>
        </nav>
        <div class="mt-6">
          <label class="block mb-2 text-sm text-gray-300">
            <i class="mdi mdi-filter-variant mr-1"></i>Filter by Area:
          </label>
          <select id="area-filter" class="block w-full bg-gray-900 text-gray-100 border border-gray-700 rounded p-2">
            <option value="All">All</option>
          </select>
        </div>
      </aside>

      <!-- Main content area -->
      <main class="flex-1 overflow-y-auto p-6">
        <section id="lights-view" class="view-section">
          <h1 class="text-3xl font-bold mb-6">RV-C Lights</h1>
          <div id="light-grid" class="space-y-8"></div>
        </section>
        <section id="logs-view" class="view-section hidden">
          <h1 class="text-3xl font-bold mb-6">Live Logs</h1>
          <div class="mb-4 flex flex-wrap gap-4">
            <select id="log-level" class="bg-gray-800 border border-gray-700 text-white rounded p-2">
              <option value="DEBUG">DEBUG</option>
              <option value="INFO" selected>INFO</option>
              <option value="WARNING">WARNING</option>
              <option value="ERROR">ERROR</option>
              <option value="CRITICAL">CRITICAL</option>
            </select>
            <input id="log-search" type="text" placeholder="Search logs..." class="bg-gray-800 border border-gray-700 text-white rounded p-2 flex-1" />
            <button id="log-pause" class="bg-gray-700 hover:bg-gray-600 text-white rounded p-2">Pause</button>
            <button id="log-resume" class="bg-gray-700 hover:bg-gray-600 text-white rounded p-2" disabled>Resume</button>
          </div>
          <pre id="log-stream" class="bg-black text-green-400 p-4 rounded overflow-auto max-h-[70vh] font-mono text-sm whitespace-pre-wrap"></pre>
        </section>
      </main>
    </div>

    <script>
      let isLogPaused = false;
      let logBuffer = [];
      const logStream = document.getElementById('log-stream');
      const logLevelSelect = document.getElementById('log-level');
      const logSearch = document.getElementById('log-search');
      const pauseBtn = document.getElementById('log-pause');
      const resumeBtn = document.getElementById('log-resume');

      const logSocket = new WebSocket(`ws://${location.host}/logs/ws`);
      logSocket.onmessage = (event) => {
        const line = event.data;
        if (!line) return;

        const selectedLevel = logLevelSelect.value;
        const searchTerm = logSearch.value.toLowerCase();
        const matchesLevel = line.includes(selectedLevel);
        const matchesSearch = searchTerm === '' || line.toLowerCase().includes(searchTerm);

        if (matchesLevel && matchesSearch) {
          if (isLogPaused) {
            logBuffer.push(line);
          } else {
            logStream.innerHTML += colorizeLog(line) + '<br/>';
            logStream.scrollTop = logStream.scrollHeight;
          }
        }
      };

      function colorizeLog(line) {
        let color = 'text-gray-400';
        if (line.includes('DEBUG')) color = 'text-blue-400';
        else if (line.includes('INFO')) color = 'text-green-400';
        else if (line.includes('WARNING')) color = 'text-yellow-400';
        else if (line.includes('ERROR')) color = 'text-red-500';
        else if (line.includes('CRITICAL')) color = 'text-pink-500';

        const escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;');
        const timestampMatch = escaped.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}/);
        const timestamp = timestampMatch ? `<span class="text-gray-500">${timestampMatch[0]}</span>` : '';
        const content = escaped.replace(timestampMatch?.[0] || '', '').trim();

        return `${timestamp} <span class="${color}">${content}</span>`;
      }

      logLevelSelect.addEventListener('change', () => {
        logStream.textContent = '';
      });

      logSearch.addEventListener('input', () => {
        logStream.textContent = '';
      });

      pauseBtn.addEventListener('click', () => {
        isLogPaused = true;
        pauseBtn.disabled = true;
        resumeBtn.disabled = false;
      });

      resumeBtn.addEventListener('click', () => {
        isLogPaused = false;
        pauseBtn.disabled = false;
        resumeBtn.disabled = true;
        logBuffer.forEach(line => {
          if (line.includes(logLevelSelect.value) && (logSearch.value === '' || line.toLowerCase().includes(logSearch.value.toLowerCase()))) {
            logStream.innerHTML += colorizeLog(line) + '<br/>';
          }
        });
        logBuffer = [];
        logStream.scrollTop = logStream.scrollHeight;
      });
    </script>
  </body>
</html>
