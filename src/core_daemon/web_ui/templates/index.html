<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rvc2api UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <main class="p-6">
      <h1 class="text-3xl font-bold mb-6">RV-C Lights</h1>
      <div id="light-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        <!-- Lights will be injected here -->
      </div>
    </main>

    <script>
      const socket = new WebSocket(`ws://${location.host}/ws`);
      const grid = document.getElementById('light-grid');
      const lightStates = {};

      function getCardColor(brightness, isOn) {
        if (!isOn) return 'bg-gray-800';
        const alpha = brightness / 100;
        return `bg-[rgba(234,179,8,${alpha.toFixed(2)})] text-black`;
      }

      function renderCard(entity) {
        const { entity_id, state, value, raw } = entity;
        const brightness = raw?.operating_status ?? 0;
        const brightnessUI = Math.round(brightness / 2);
        const isOn = state === 'on';
        const colorClass = getCardColor(brightnessUI, isOn);

        const card = document.createElement('div');
        card.className = `rounded-2xl p-4 shadow transition-colors duration-300 ${colorClass}`;
        card.style.cursor = 'pointer';
        card.id = entity_id;
        card.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">${entity_id}</h2>
          <p class="mb-2">State: <strong>${state}</strong></p>
          <p class="mb-2">Brightness: ${brightnessUI}%</p>
          ${'brightness' in value ? `<input type="range" min="0" max="100" value="${brightnessUI}" class="w-full slider" />` : ''}
        `;

        card.addEventListener('click', (e) => {
          if (e.target.tagName === 'INPUT') return;
          fetch(`/entities/${entity_id}/control`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: 'toggle' })
          });
        });

        const slider = card.querySelector('input');
        if (slider) {
          slider.addEventListener('input', (e) => {
            const level = parseInt(e.target.value);
            fetch(`/entities/${entity_id}/control`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ command: 'set', state: 'on', brightness: level })
            });
          });
        }

        return card;
      }

      function updateCard(entity) {
        const existing = document.getElementById(entity.entity_id);
        const updated = renderCard(entity);
        if (existing) {
          grid.replaceChild(updated, existing);
        } else {
          grid.appendChild(updated);
        }
      }

      socket.onmessage = (event) => {
        const payload = JSON.parse(event.data);
        if (!payload.entity_id) return;
        lightStates[payload.entity_id] = payload;
        updateCard(payload);
      };

      fetch('/lights')
        .then((res) => res.json())
        .then((data) => {
          for (const entity_id in data) {
            updateCard(data[entity_id]);
          }
        });
    </script>
  </body>
</html>
